#!/usr/bin/env python3
from boututils.run_wrapper import shell, launch_safe, getmpirun
import numpy as np
import shutil
import zipfile
import hashlib
from pathlib import Path
import urllib.request
import xhermes

gen_data = False
verbose = False
rtol = 1e-6
atol = 1e-8

## Setup
this_dir = Path(__file__).parent
data_dir = this_dir / "data"
hermes_exec = this_dir.parent.parent.parent / "hermes-3"
output_path = data_dir / "BOUT.dmp.*.nc"

zipfile_path = this_dir / "test-2D-production.zip"
url = "https://zenodo.org/records/18301171/files/test-2D-production-v1.zip"
expected_hash = "b8e2be76791fad1fe7fe8c8734b3020eb63e7da5d69a4fafdf7c9a4695785ff3"
expected_filenames = [
    "BOUT.restart.0.nc",
    "BOUT.restart.1.nc",
    "BOUT.restart.2.nc",
    "BOUT.restart.3.nc",
    "BOUT.restart.4.nc",
    "BOUT.restart.5.nc",
    "BOUT.restart.6.nc",
    "BOUT.restart.7.nc",
    "BOUT.restart.8.nc",
    "BOUT.restart.9.nc",
    "grid_test2.nc",
]


## Download files
tmp_path = zipfile_path.with_name(zipfile_path.name + ".tmp")

with urllib.request.urlopen(url, timeout=60) as response:
    if response.status != 200:
        raise RuntimeError(
            f"2D-Production test: download failed - HTTP {response.status}"
        )

    # Copy bits of the file from response to a temp file
    # This ensures no partial files are left if the download fails
    with open(tmp_path, "wb") as out_file:
        shutil.copyfileobj(response, out_file)

# Rename temp file with the correct name
tmp_path.replace(zipfile_path)

with zipfile.ZipFile(zipfile_path, "r") as zf:
    zip_contents = set(zf.namelist())
    try:
        # Extract only expected grids
        for filename in expected_filenames:
            if filename in zip_contents:
                zf.extract(filename, path=this_dir)

    except Exception as e:
        print("2D-Production test: extracting test grids failed:", e)

# Check hash
with open(zipfile_path, "rb") as f:
    file_hash = hashlib.sha256(f.read()).hexdigest()

if file_hash != expected_hash:
    raise RuntimeError(
        "2D-Production test: downloaded zip file hash does not match expected value"
    )

if verbose:
    print("2D-Production test: downloaded and extracted files")

## Run test
if not Path("hermes-3").is_file():
    shell("ln -s ../../../hermes-3 hermes-3")

runcmd = getmpirun().split(" ")[0] + " --oversubscribe -np"

s, out = launch_safe("./hermes-3 -d data", runcmd=runcmd, nproc=10, pipe=True)

if s != 0:
    print(" => 2D-Production test failed: ")
    print(out)
    exit(1)

if verbose:
    print("2D-Production test: completed simulation")

# Load case
ds = xhermes.open_hermesdataset(
    datapath=output_path,
    gridfilepath=this_dir / "grid_test2.nc",
    keep_yboundaries=True,
    keep_xboundaries=True,
    geometry="toroidal",
).isel(t=-1)

ds = ds.hermes.extract_2d_tokamak_geometry()

if verbose:
    print("2D-Production test: loaded results")


# Testing at specific locations around the domain
m = ds.metadata
x_selection = slice(None)
regions = {}
regions["inner_lower_target"] = ds.isel(x=x_selection, theta=2)
regions["inner_upper_target"] = ds.isel(
    x=x_selection, theta=m["ny_innerg"] - m["MYG"] * 2 - 1
)
regions["outer_upper_target"] = ds.isel(x=x_selection, theta=m["ny_innerg"])
regions["outer_lower_target"] = ds.isel(x=x_selection, theta=-3)
regions["outer_midplane_a"] = ds.isel(
    x=x_selection, theta=int((m["jyseps2_2g"] - m["jyseps1_2g"]) / 2) + m["jyseps1_2g"]
)
regions["sol_boundary"] = ds.isel(x=-3, theta=slice(None))
regions["core_and_pfr_boundary"] = ds.isel(x=0, theta=slice(None))
regions["sol_ring"] = ds.isel(x=m["ixseps1"], theta=slice(None))

# Expected results
# The below line disables Ruff formatting for the data to keep it readable
# fmt: off

expected = {}
expected["inner_lower_target"] = {}
expected["inner_lower_target"]["ddt(Pe)"] = [-2254150993.1389914, -3073740419.4269204, -4304701073.959349, -4269066952.7525907, -4228697752.939156, -4200929874.1502237, -4183500746.174234, -4175625117.0715837, -4179033625.223881, -4197902912.0560207, -4228284968.242892, -4273048763.8359737, -4351698791.518655, -4486937361.187624, -4719724788.968353, -5123064508.860707, -5776623167.386452, -6640948318.690931, -3157976130.756027, -2863810355.9420953]
expected["inner_lower_target"]["ddt(NVd+)"] = [-2876457499.0469804, -2873579921.6356535, -97627.24504379673, -97596.10888716359, -96747.42232167657, -96058.20178528104, -95580.74155019174, -95337.42165768695, -95409.4517602352, -95933.62269462293, -96904.00713677752, -98483.08235885236, -101188.58958132581, -105856.29605396457, -113930.86116849778, -127806.79333247924, -149513.45342900683, -176445.07807561904, -8567292539.6016865, -8923740636.816994]
expected["inner_lower_target"]["ddt(Pd)"] = [204284702.2325076, 42970841.60944467, -761198037.5709945, -760632577.8647087, -754250937.7674593, -749091827.6054981, -745478766.2166774, -743584010.156937, -744044869.5438389, -747942360.353002, -755230392.3915982, -767134715.6345025, -787569846.3178265, -822821736.3608307, -883877669.2587775, -989356448.1231848, -1155230964.8221922, -1361929622.910942, 41736421.914583854, 98764327.63177752]

expected["inner_upper_target"] = {}
expected["inner_upper_target"]["ddt(Pe)"] = [-2249152823.424196, -3066242155.371278, -4295770751.600127, -4254872426.015915, -4210498602.1580405, -4180100235.2059345, -4161242275.6555953, -4152904649.819989, -4156744734.6890473, -4176838913.5833826, -4209080423.9468446, -4256451606.5975037, -4338765768.480933, -4479395593.91835, -4721057816.33791, -5136371349.210212, -5806445675.864205, -6691881065.038814, -3185233789.661162, -2888401943.5757537]
expected["inner_upper_target"]["ddt(NVd+)"] = [56999.881325567934, 58340.43660080817, 97345.5188139974, 97141.47190617448, 96166.93464244413, 95393.8321983007, 94870.06220581497, 94610.975164105, 94695.22774918472, 95256.36210410159, 96284.12597307982, 97945.14411346543, 100767.63092717969, 105610.18605337419, 113976.11372666097, 128239.62944230642, 150445.3904977982, 177963.87636719222, 37624.12806869028, 26929.449776507547]
expected["inner_upper_target"]["ddt(Pd)"] = [223437270.57567328, 66231675.50313131, -734400542.6153917, -733069918.0951861, -725657879.9160883, -719776521.3817779, -715792121.8822984, -713821407.9969631, -714462529.1143869, -718731488.1312238, -726551260.9400027, -739191995.678221, -760680155.9227257, -797572231.1696265, -861380033.707792, -970384341.7327268, -1140628977.4201615, -1352507154.0151904, 44496581.670963064, 100066660.79528038]

expected["outer_upper_target"] = {}
expected["outer_upper_target"]["ddt(Pe)"] = [-10397595065.872946, -10244985777.43689, -9410974635.638746, -9281063172.1434, -9199482784.657938, -9127858782.681114, -9061872647.570805, -9000188171.22056, -8942303811.516203, -8887879614.589325, -8833218960.502167, -8766244916.761372, -8670907589.989502, -8541727161.54007, -8397633568.82065, -8295461365.421472, -8330518965.125202, -8557158587.695316, -4411614404.625938, -4728752786.501921]
expected["outer_upper_target"]["ddt(NVd+)"] = [-6067718136.518331, -6087270808.976671, -262269.22745637485, -259561.3088131007, -257047.6191157174, -254749.36002343477, -252631.5237752473, -250670.15149982195, -248850.17405455303, -247153.38027803044, -245458.76607655626, -243391.9022030548, -240464.06019249934, -236518.42423520715, -232158.43612747637, -229194.7650932585, -230691.13855439285, -238323.35130664153, -59420630799.809715, -76302081350.08084]
expected["outer_upper_target"]["ddt(Pd)"] = [-1301703822.2751708, -1278618338.6963696, -2000542706.608684, -1979459829.700815, -1959645822.240519, -1941531254.4686902, -1924877114.7124467, -1909506019.370622, -1895292803.5890079, -1882088083.6083286, -1868943527.442849, -1852968470.5524812, -1830456210.1121943, -1800344479.1118054, -1767348360.0701127, -1745491301.6473043, -1758455903.9828343, -1819284837.119908, -185417888.6067911, -246049998.7445224]

expected["outer_lower_target"] = {}
expected["outer_lower_target"]["ddt(Pe)"] = [-10200009338.563726, -10051311961.361673, -9269863667.814798, -9146620036.970808, -9068092057.866709, -8997330060.0824, -8931815711.893589, -8870759153.41723, -8813413564.42985, -8757837084.070076, -8701909413.374527, -8634688988.490685, -8540888128.672883, -8416746555.390143, -8283623589.113983, -8203870689.23253, -8275793023.442977, -8543066868.007766, -4391787702.473702, -4732096908.442924]
expected["outer_lower_target"]["ddt(NVd+)"] = [62664.034151037944, 64145.42437224565, 257814.38866962225, 255175.19611743078, 252721.50955644026, 250468.61263064807, 248391.08276031943, 246473.61059712755, 244685.68275039148, 242960.66330710799, 241230.79539510777, 239160.15894299504, 236281.9213794133, 232491.93219580056, 228476.69592829634, 226227.40795286477, 228917.99880453863, 237996.81582095733, 41896.458798063046, 27902.6046303327]
expected["outer_lower_target"]["ddt(Pd)"] = [-1271497587.2971692, -1249098088.9113514, -1973136126.6090546, -1952727888.1177034, -1933524965.1024578, -1915901179.4124458, -1899655711.8802333, -1884667382.3502302, -1870696465.711829, -1857221392.0613925, -1843712667.021828, -1827548426.8177984, -1805089859.4347546, -1775535168.2765124, -1744246780.1676364, -1726730792.9984972, -1747689724.7440643, -1818455358.2675047, -181987833.1266779, -246705779.14146453]

expected["outer_midplane_a"] = {}
expected["outer_midplane_a"]["ddt(Pe)"] = [575756625875.2131, 575755521448.4669, 2597004.635382859, -113.83537210831166, -116.55461925178231, -116.35833624604983, -116.2485306522665, -116.15420464481828, -116.05941107409704, -115.96090133909178, -115.9626351349297, -116.01716207077, -116.05137276824046, -116.07307591513715, -116.16348327577923, -117.60245957419926, -178.75678817996626, -3921408.1266655624, 6442717000.311359, 114821529938.12538]
expected["outer_midplane_a"]["ddt(NVd+)"] = [9892.902733379971, 9872.980482915196, 7.499749974956263e-10, -7.35304298346607e-09, -5.372172239470407e-09, -4.10681132381757e-09, -3.6246618608662986e-09, -3.452274034455348e-09, -3.279139696739363e-09, -3.0796205034511645e-09, -3.2032029497960755e-09, -3.5547789489516103e-09, -3.950440449838461e-09, -4.537271849902104e-09, -5.8061972355968764e-09, -1.3319334062798185e-08, -6.030832073271068e-08, 0.0013857453700421316, 42259.25661181993, 42271.90877205074]
expected["outer_midplane_a"]["ddt(Pd)"] = [5292523605401.681, 5292533435880.962, 451.9136805496931, 451.71627168696585, 451.4688427239247, 451.3547026580658, 451.28842243349214, 451.25271171596785, 451.23532017368194, 451.2260371817324, 451.2193464542157, 451.21147630418204, 451.1989088099733, 451.1685735337419, 450.9047702285618, 444.70807319831266, 357.84417739495905, 72858.94454450821, 59831513063.10754, 1055987782544.328]

expected["sol_boundary"] = {}
expected["sol_boundary"]["ddt(Pe)"] = [8868268136.117844, 11535562516.824797, -6640948318.690931, -1282140487.0737138, -1180233142.1504326, -1029773356.577504, -785675490.1418087, -79814193.85319163, -3537194.350424702, -2456989.038516414, -2829378.6209409544, -2918133.5068461034, -2918133.355478638, -2829381.364441966, -2458513.9397100853, -3598932.76222915, -81813146.19817922, -799754006.985688, -1041544974.7388103, -1188543282.9288094, -1287783483.3034122, -6691881065.038814, 10737898675.359179, 8861394946.342846, 7014343691.57176, 14848466048.381994, -8557158587.695316, -1309101199.8121011, -1260192274.870617, -1190188938.6184437, -1096438041.1278222, -967342017.3700871, -799757814.4915521, -599914543.444626, -417023416.71831733, -237538754.52027607, -38092509.980572, -2988916.983436025, -2648692.7390759657, -3528396.555672957, -3921408.1266655624, -3921416.7290678513, -3528646.1433867947, -2655206.1288240505, -3138140.345522591, -41080270.828763574, -252259626.5099754, -434749502.3837908, -616137869.1912032, -811994771.8269938, -976006045.7649654, -1098825710.1861382, -1200320225.5494895, -1248647782.734018, -1320868768.8478534, -8543066868.007766, 13303989340.46726, 6987507206.715792]
expected["sol_boundary"]["ddt(NVd+)"] = [65490.40752374213, 255001.1235352431, -176445.07807561904, -141.0952164220934, -7.781112292514369, -6.441488364064953, -3.9051444001030453, -0.5211639503857192, -0.01694643239306119, 0.0014373905311962445, 0.0008859980539215484, 0.0001681170867500445, -0.00016811852322986919, -0.0008856985557760528, -0.001423617970768444, 0.01754692748805616, 0.5359505588634336, 4.016483308383749, 6.5447804618958765, 7.912769668322992, 144.2850460867794, 177963.87636719222, 18601630190.19816, 66232.81342860259, 65286.966864612434, 316781.09435260406, -238323.35130664153, -293.9951494797621, -11.65344494765728, -9.726278730386962, -8.013533740521858, -6.279965673975994, -4.39933212267748, -2.667979592587002, -1.7923109122101308, -0.8237688143451212, -0.14884007353754614, -0.006552072101751951, 0.004940349610768572, 0.004300036950704916, 0.0013857453700421316, -0.0013856924768584464, -0.004298225344058128, -0.00489811435987596, 0.007491699542441823, 0.1615071988634937, 0.8850492194130107, 1.8905545938715675, 2.7615720987468015, 4.500410354278493, 6.371015612725898, 8.0885020604466, 9.78215442299334, 11.671012541267782, 295.53589559009026, 237996.81582095733, 105618870567.42488, 66435.19076954712]
expected["sol_boundary"]["ddt(Pd)"] = [82153266883.81812, 701211476.153413, -1361929622.910942, 25120.12603570814, 22813.29536662568, 20352.6776646538, 21971.35980199825, 22038.4815425205, 30101.84963520319, 45128.0532396469, 52716.715823250066, 54345.78595148986, 54345.785951298836, 52716.71582353633, 45128.05323980129, 30101.849821774365, 22038.40502422009, 21958.50207540844, 20327.36175997148, 22758.964943743023, 24991.070952795588, -1352507154.0151904, 701725582.8165573, 82089191842.00555, 65112382595.44785, 721851911.5324777, -1819284837.119908, 29504.098192161706, 26901.732902512522, 25684.136221771845, 24561.106698006537, 23489.1950800885, 21756.286733016925, 19069.091463150977, 18027.428432151937, 19238.41918672569, 19783.388153402524, 36036.3091218926, 57412.4003766898, 74652.41625976101, 72858.94454450821, 72858.94454439155, 74652.41626037905, 57412.40510854262, 36036.26858399813, 19116.917594222108, 19224.443427509832, 17992.18051414163, 18997.146871683788, 21613.51680892647, 23269.651144185023, 24273.919533746342, 25331.39336963068, 26486.766742302723, 29007.333967974668, -1818455358.2675047, 721749552.6379924, 64865800888.02975]

expected["core_and_pfr_boundary"] = {}
expected["core_and_pfr_boundary"]["ddt(Pe)"] = [5169904828.030926, 1473737170.234175, -2254150993.1389914, 5169904828.030926, 41131675141.4215, 71094056970.55853, 113892002069.15747, 575730059402.7075, 575773274268.2708, 575755891417.8629, 575753870369.6442, 575757282855.2455, 575757282855.238, 575753870369.6616, 575755891417.8097, 575773274268.3557, 575730059402.4539, 114135586230.81172, 71684903216.74065, 41627230483.743416, 5188785369.444783, -2249152823.424196, 1470514787.3024106, 5188785369.444783, 2981669822.0685477, 1670361927.8301291, -10397595065.872946, 2981669822.0685477, 16807741095.876812, 17185936111.682777, 17707134171.34622, 18439466693.888805, 20022454118.95044, 26226597540.178806, 55758155326.234276, 113139067503.92157, 575738665062.4811, 575768924601.6606, 575760583247.9943, 575753169466.8334, 575756625875.2131, 575756625875.2083, 575753169466.8298, 575760583247.996, 575768924601.7194, 575738665062.2513, 113206570289.58765, 56606290372.50853, 26727433776.581432, 20310250726.369194, 18644780960.669704, 17871409122.56456, 17320499015.399673, 16918431079.587034, 2970877001.017949, -10200009338.563726, 1666636007.206979, 2970877001.017949]
expected["core_and_pfr_boundary"]["ddt(NVd+)"] = [55764.01159774272, 57289.09362590487, -2876457499.0469804, 55764.01159774259, 54488.29973963233, 51138.45162397818, 48107.80977395676, 10513.935662467324, 10115.586631360655, 9713.265600820061, 9843.694035728384, 9898.073967355525, 9859.67569905285, 9914.05566679867, 10044.483862742201, 9642.162502278574, 9243.814330538822, 48084.58710976903, 50977.47309079995, 54111.41118333199, 56242.44713767325, 56999.881325567934, 2881520769.507945, 56242.447137673116, 61635.0816207218, 63380.94479200141, -6067718136.518331, 61635.08162072062, 62199.854614412834, 61770.96013155883, 61354.91931223996, 60758.678538299435, 59690.37636740919, 57242.43001576391, 52270.70184373357, 47649.6334521631, 10492.828020617575, 10120.588758896885, 9733.242296498853, 9810.221340847042, 9892.902733379971, 9864.846910536755, 9947.52831351279, 10024.507080716425, 9637.160432393388, 9264.921872307936, 47662.51149373226, 52021.69272123804, 56809.66752593064, 59234.39389814305, 60350.856749546474, 60926.13507390766, 61284.351900205154, 61439.24243120889, 62480.986322058125, 62664.034151037944, 6053036162.421262, 62480.98632205706]
expected["core_and_pfr_boundary"]["ddt(Pd)"] = [48160517465.079254, 671191156.875534, 204284702.2325076, 48160517069.75538, 378691334280.7243, 654080861735.1915, 1047444323978.5565, 5292279425584.831, 5292676622550.901, 5292516855859.028, 5292498279314.288, 5292529643755.424, 5292529643986.1, 5292498278913.807, 5292516854053.9, 5292676625123.911, 5292279432059.361, 1049683149100.1729, 659511434793.9685, 383246058271.93353, 48333849758.59565, 223437270.57567328, 671023809.0663531, 48333849362.3097, 28047518680.5672, 725265826.0054145, -1301703822.2751708, 28047518609.14197, 155125128467.84885, 158601676223.86145, 163392211059.11908, 170123224515.00104, 184672745383.53027, 241696126673.13922, 513125885570.2451, 1040523970873.7367, 5292358522018.669, 5292636644179.036, 5292559979032.262, 5292491837287.372, 5292523605401.681, 5292523605516.088, 5292491836717.473, 5292559977746.839, 5292636646395.18, 5292358527833.99, 1041144400739.3044, 520921245473.54144, 246299402602.9121, 187317936643.61972, 172010306309.74707, 164902101125.97464, 159838536245.63397, 156142800265.50616, 27948475688.864014, -1271497587.2971692, 723738324.9428847, 27948475625.173943]

expected["sol_ring"] = {}
expected["sol_ring"]["ddt(Pe)"] = [5218318047.940172, 7510861737.832366, -4228284968.242892, -1173848475.691532, -824957891.7282962, -137028039.67263415, -1030420.1259898415, -2783.5002745663714, -159.70341685682288, -117.94928971432628, -116.12613887021368, -117.18203722296013, -117.18203722371747, -116.1263585428126, -117.95382448039253, -159.92990482711159, -2816.71624626293, -1042237.9652537291, -137492892.37891495, -823691589.1567771, -1172451612.7898698, -4209080423.9468446, 7168442746.421198, 5266911965.25474, 1510192608.0235603, 15659110714.36319, -8833218960.502167, -1359833540.7138731, -1312448940.3963022, -1232360937.167797, -1105313819.947443, -915960005.3144358, -634169453.1609572, -265117584.8733709, -16596207.950507542, -59262.146888833704, -213.0381046793803, -136.12792241519267, -117.25086682839228, -115.4235045018323, -115.9626351349297, -115.96263877018262, -115.42359269591195, -117.25097781547028, -136.12912197667276, -212.83053485563232, -59193.88562194647, -16451153.532998627, -261882923.36069047, -627894215.497538, -909659129.8092992, -1100208906.3953683, -1229079749.3534145, -1309897329.7163596, -1359823861.494911, -8701909413.374527, 13745035268.107126, 1538651238.5629756]
expected["sol_ring"]["ddt(NVd+)"] = [65434.50051658902, 178001.84661965724, -96904.00713677752, -43.77765026833127, -4.50632862524322, -0.7669688580957525, -0.0188455041860195, -6.871039601365519e-05, -3.3926026695737815e-07, -9.344121711367159e-08, -1.6789975996237664e-08, -5.395703985285907e-10, 5.395703985302547e-10, 1.679115555448735e-08, 9.348032542429422e-08, 3.4387344733096577e-07, 6.948289969586688e-05, 0.018980755615464136, 0.7676215344388491, 4.511611190959939, 43.796642810210656, 96284.12597307982, 3436062798.1108084, 66286.74959162601, 65465.981951253074, 331840.75448988256, -245458.76607655626, -297.2709631299531, -11.766382847027488, -9.61557034400263, -7.544381441874319, -5.307573544083617, -2.9591603488993745, -0.9782728220850124, -0.10215331673046131, -0.0012135294189584373, -2.8397330268208552e-06, 3.110738472236028e-08, -9.387788717963045e-08, -2.2513154365366236e-08, -3.2032029497960755e-09, 3.2032029382243225e-09, 2.2513745472777303e-08, 9.387932739407059e-08, -3.134409008135863e-08, 2.8292866598121718e-06, 0.0012057530319063154, 0.10087354169067309, 0.9643246330690529, 2.917374124632406, 5.244940780571081, 7.473048410016512, 9.527478160564833, 11.619500643278176, 288.11215855646435, 241230.79539510777, 7104853769.206236, 66248.71553063302]
expected["sol_ring"]["ddt(Pd)"] = [48605509437.74865, 674805096.0889126, -755230392.3915982, 441.5810666545734, 501.71169614695975, 547.6210748066243, 436.20560246623296, 411.216931933753, 521.4013127047592, 466.75946062492744, 454.37718778695904, 453.478450489408, 453.47845049030406, 454.377187787009, 466.7594606165834, 521.401270652253, 411.1199464870461, 436.4305675924275, 547.2881587470255, 501.4718485794517, 436.94641724814494, -726551260.9400027, 674603121.4044243, 49051919529.5787, 14523107245.293663, 724224729.2292237, -1868943527.442849, 993.7593818771591, 444.3871994357772, 453.88278404509606, 455.80216564313037, 458.54054561565977, 463.75961184483447, 489.3260324072204, 507.518150494338, 430.0485215371676, 418.6476147472901, 499.7149145485432, 462.4372627720304, 453.060204897884, 451.2193464542157, 451.2193464561671, 453.06020489749534, 462.4372627611499, 499.7148396985487, 418.4749141906653, 430.30165080823826, 507.5327498593158, 489.2385694689337, 463.61847460719724, 458.4279144800273, 455.7703222167547, 453.8693606333196, 444.2316872256889, 967.3700548617134, -1843712667.021828, 722818833.0055773, 14784751530.54281]

# fmt: on

# Generate test data or run test
if gen_data:
    # Generate test data, print to console and fail test
    for region_name, ds in regions.items():
        print(f'expected["{region_name}"] = {{}}')
        print(f'expected["{region_name}"]["ddt(Pe)"] = {ds["ddt(Pe)"].values.tolist()}')
        print(f'expected["{region_name}"]["ddt(NVd+)"] = {ds["ddt(NVd+)"].values.tolist()}')
        print(f'expected["{region_name}"]["ddt(Pd)"] = {ds["ddt(Pd)"].values.tolist()}')
        print("")

else:
    # Perform test
    failures = []
    for region_name, ds in regions.items():
        for variable in ["ddt(Pe)", "ddt(NVd+)"]:
            actual = ds[variable]
            reference = expected[region_name][variable]

            try:
                np.testing.assert_allclose(actual, reference, rtol=rtol, atol=atol)
            except AssertionError as e:
                failures.append(
                    {"region": region_name, "variable": variable, "error_msg": str(e)}
                )

    if len(failures) > 0:
        print("2D-production test failures:")
        for f in failures:
            print(f"\n{f['region']} [{f['variable']}]:")
            print(f["error_msg"])

        exit(1)

    else:
        if verbose:
            print("2D-production test: Passed")
        exit(0)
