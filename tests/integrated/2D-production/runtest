#!/usr/bin/env python3
from boututils.run_wrapper import shell, launch_safe, getmpirun
import numpy as np
import shutil
import zipfile
import hashlib
from pathlib import Path
import urllib.request
import xhermes

gen_data = False
verbose = False
rtol = 1e-6
atol = 1e-8

## Setup
this_dir = Path(__file__).parent
data_dir = this_dir / "data"
hermes_exec = this_dir.parent.parent.parent / "hermes-3"
output_path = data_dir / "BOUT.dmp.*.nc"

zipfile_path = this_dir / "test-2D-production.zip"
url = "https://zenodo.org/records/18301171/files/test-2D-production-v1.zip"
expected_hash = "b8e2be76791fad1fe7fe8c8734b3020eb63e7da5d69a4fafdf7c9a4695785ff3"
expected_filenames = [
    "BOUT.restart.0.nc",
    "BOUT.restart.1.nc",
    "BOUT.restart.2.nc",
    "BOUT.restart.3.nc",
    "BOUT.restart.4.nc",
    "BOUT.restart.5.nc",
    "BOUT.restart.6.nc",
    "BOUT.restart.7.nc",
    "BOUT.restart.8.nc",
    "BOUT.restart.9.nc",
    "grid_test2.nc",
]


## Download files
tmp_path = zipfile_path.with_name(zipfile_path.name + ".tmp")

with urllib.request.urlopen(url, timeout=60) as response:
    if response.status != 200:
        raise RuntimeError(
            f"2D-Production test: download failed - HTTP {response.status}"
        )

    # Copy bits of the file from response to a temp file
    # This ensures no partial files are left if the download fails
    with open(tmp_path, "wb") as out_file:
        shutil.copyfileobj(response, out_file)

# Rename temp file with the correct name
tmp_path.replace(zipfile_path)

with zipfile.ZipFile(zipfile_path, "r") as zf:
    zip_contents = set(zf.namelist())
    try:
        # Extract only expected grids
        for filename in expected_filenames:
            if filename in zip_contents:
                zf.extract(filename, path=this_dir)

    except Exception as e:
        print("2D-Production test: extracting test grids failed:", e)

# Check hash
with open(zipfile_path, "rb") as f:
    file_hash = hashlib.sha256(f.read()).hexdigest()
    print(file_hash)

if file_hash != expected_hash:
    raise RuntimeError(
        "2D-Production test: downloaded zip file hash does not match expected value"
    )

if verbose:
    print("2D-Production test: downloaded and extracted files")

## Run test
if not Path("hermes-3").is_file():
    shell("ln -s ../../../hermes-3 hermes-3")

runcmd = getmpirun().split(" ")[0] + " --oversubscribe -np"

s, out = launch_safe("./hermes-3 -d data", runcmd=runcmd, nproc=10, pipe=True)

if s != 0:
    print(" => 2D-Production test failed: ")
    print(out)
    exit(1)

if verbose:
    print("2D-Production test: completed simulation")

# Load case
ds = xhermes.open_hermesdataset(
    datapath=output_path,
    gridfilepath=this_dir / "grid_test2.nc",
    keep_yboundaries=True,
    keep_xboundaries=True,
    geometry="toroidal",
).isel(t=-1)

ds = ds.hermes.extract_2d_tokamak_geometry()

if verbose:
    print("2D-Production test: loaded results")


# Testing at specific locations around the domain
m = ds.metadata
x_selection = slice(None)
regions = {}
regions["inner_lower_target"] = ds.isel(x=x_selection, theta=2)
regions["inner_upper_target"] = ds.isel(
    x=x_selection, theta=m["ny_innerg"] - m["MYG"] * 2 - 1
)
regions["outer_upper_target"] = ds.isel(x=x_selection, theta=m["ny_innerg"])
regions["outer_lower_target"] = ds.isel(x=x_selection, theta=-3)
regions["outer_midplane_a"] = ds.isel(
    x=x_selection, theta=int((m["jyseps2_2g"] - m["jyseps1_2g"]) / 2) + m["jyseps1_2g"]
)
regions["sol_boundary"] = ds.isel(x=-3, theta=slice(None))
regions["core_and_pfr_boundary"] = ds.isel(x=0, theta=slice(None))
regions["sol_ring"] = ds.isel(x=m["ixseps1"], theta=slice(None))

# Expected results
# The below line disables Ruff formatting for the data to keep it readable
# fmt: off
expected = {}
expected["inner_lower_target"] = {}
expected["inner_lower_target"]["Pe"] = [1454.2692561814526, 1454.2692561814522, 1682.2395985594858, 1682.2397131905661, 1682.2401077193579, 1682.2404252643541, 1682.240645469899, 1682.240757906863, 1682.2407250014674, 1682.2404834386064, 1682.24003612604, 1682.2393086181562, 1682.2380635829395, 1682.2359205787548, 1682.2322297169405, 1682.2259342944174, 1682.216217675694, 1682.2043522962742, 686.2916714584352, 686.2916714584348]
expected["inner_lower_target"]["NVd+"] = [0.0, 4.457248399014597e-07, -5.155963880530983e-07, -5.154062033917175e-07, -5.108709318451393e-07, -5.071901505115961e-07, -5.046410135857132e-07, -5.033421359606755e-07, -5.037266474540163e-07, -5.065248567581666e-07, -5.117057958823623e-07, -5.201387994210897e-07, -5.345947196545816e-07, -5.595561336655766e-07, -6.027998068918092e-07, -6.773017796714837e-07, -7.943315755121567e-07, -9.403664243750886e-07, 3.836428340509419e-07, -5.679555365512e-23]

expected["inner_upper_target"] = {}
expected["inner_upper_target"]["Pe"] = [1452.2968431521017, 1452.2968431521015, 1682.2397291872012, 1682.2399234405714, 1682.2403766724053, 1682.240733441618, 1682.2409753421873, 1682.2410951998597, 1682.2410566233752, 1682.240797794253, 1682.2403236599705, 1682.2395578768549, 1682.2382583470094, 1682.236034348401, 1682.2322097636168, 1682.2257397335393, 1682.21580615535, 1682.2036980608607, 684.9349910554657, 684.9349910554661]
expected["inner_upper_target"]["NVd+"] = [0.0, -4.438305802981575e-07, 5.141024982091592e-07, 5.129874080826323e-07, 5.077806436596672e-07, 5.036525479420523e-07, 5.008565840425194e-07, 4.994737288939555e-07, 4.999233867621355e-07, 5.029184583854898e-07, 5.084049970559749e-07, 5.172745579964543e-07, 5.323540467161482e-07, 5.582487860375578e-07, 6.030522429780205e-07, 6.796401625779191e-07, 7.993809636925741e-07, 9.486426595587287e-07, -3.862543830385655e-07, 0.0]

expected["outer_upper_target"] = {}
expected["outer_upper_target"]["Pe"] = [1592.6653676129774, 1592.6653676129777, 1682.1689930534826, 1682.170242942198, 1682.1712282449635, 1682.1721319317335, 1682.1729664751601, 1682.1737407921592, 1682.1744607630892, 1682.1751335083145, 1682.1758073387211, 1682.1766325447581, 1682.1778075586515, 1682.179401832741, 1682.1811806575743, 1682.182416276892, 1682.181861682993, 1682.1788392932533, 714.1017087651426, 714.1017087651426]
expected["outer_upper_target"]["NVd+"] = [0.0, 1.337201918923233e-06, -1.4123491671295575e-06, -1.397042775763656e-06, -1.3830985015089022e-06, -1.3703569868732152e-06, -1.3586219495771779e-06, -1.3477591269721744e-06, -1.337683890117968e-06, -1.32829447188241e-06, -1.3189208083107995e-06, -1.3074930434261745e-06, -1.2913142649528537e-06, -1.2695286416188555e-06, -1.2454782077179828e-06, -1.2291420015985059e-06, -1.237379778459094e-06, -1.2794701125396479e-06, 5.431478344254762e-07, 0.0]

expected["outer_lower_target"] = {}
expected["outer_lower_target"]["Pe"] = [1590.3275203244334, 1590.327520324433, 1682.17074952576, 1682.171973232721, 1682.1729405958047, 1682.1738305353003, 1682.1746528730748, 1682.1754135253702, 1682.1761246372073, 1682.1768133199546, 1682.1775060986, 1682.1783381989032, 1682.1795005235597, 1682.1810410092476, 1682.1826897838803, 1682.1836417538339, 1682.1826015842503, 1682.1789935680276, 707.6090348682918, 707.6090348682922]
expected["outer_lower_target"]["NVd+"] = [0.0, -1.311856149052577e-06, 1.3876173387677787e-06, 1.3727143019589649e-06, 1.3591170965891498e-06, 1.3466398900375323e-06, 1.3351398900699605e-06, 1.3245309176796656e-06, 1.3146430265242597e-06, 1.3051069449701752e-06, 1.2955479216735619e-06, 1.2841109370000628e-06, 1.2682224090819082e-06, 1.2473171409940362e-06, 1.2251892426360888e-06, 1.212800202036759e-06, 1.2276096517503688e-06, 1.277667066421288e-06, -5.374509866133388e-07, 0.0]

expected["outer_midplane_a"] = {}
expected["outer_midplane_a"]["Pe"] = [1682.2854656993893, 1682.2854792559663, 1682.2854792559663, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854656993893, 1682.2854452327351, 1079.4127634213644, 1079.4127634213644]
expected["outer_midplane_a"]["NVd+"] = [0.0, -3.647750812324287e-23, 3.647750812324287e-23, -4.632036025468437e-23, -4.784246060300552e-23, -4.869435077430761e-23, -4.005923512728878e-23, -4.0178098888263794e-23, -4.9289852114901715e-23, -4.9297149583868224e-23, -5.207143796679161e-23, -6.112755696587186e-23, -6.107874623047261e-23, -6.096630678361953e-23, -6.071647745613448e-23, -7.566232195478394e-23, -9.33971541459335e-23, 1.8086927924796042e-17, -1.1605201072405524e-17, 0.0]

expected["sol_boundary"] = {}
expected["sol_boundary"]["Pe"] = [1682.2826684400206, 1682.1260397984188, 1682.2043522962742, 1682.2826684400202, 1682.2854054009579, 1682.2854594380296, 1682.285459641328, 1682.2854595961248, 1682.2854573171287, 1682.2854530779553, 1682.2854509337556, 1682.2854504723623, 1682.2854504723623, 1682.2854509337556, 1682.2854530779553, 1682.2854573171287, 1682.2854595961248, 1682.2854596450934, 1682.2854593861905, 1682.2854022691645, 1682.2825880576672, 1682.2036980608607, 1682.1248117635703, 1682.2825880576675, 1682.2776385182347, 1682.0800458706951, 1682.1788392932533, 1682.2776385182344, 1682.2848452913934, 1682.2854268257465, 1682.2854576583854, 1682.2854589324868, 1682.2854594581336, 1682.2854602465295, 1682.2854605593773, 1682.2854602093746, 1682.285460234525, 1682.2854582026878, 1682.2854521684235, 1682.2854472919723, 1682.2854452327351, 1682.2854452327351, 1682.2854472919723, 1682.2854521684235, 1682.2854582026878, 1682.2854602345258, 1682.2854602137897, 1682.2854605699158, 1682.2854602676857, 1682.2854595000858, 1682.2854589944027, 1682.2854576332297, 1682.285424799778, 1682.284827007958, 1682.2775905083754, 1682.1789935680276, 1682.0804024063675, 1682.2775905083754]
expected["sol_boundary"]["NVd+"] = [0.0, -0.05613510654141201, -9.403664243750886e-07, -3.3022779714140016e-12, -4.017580118481114e-14, -5.625742811924772e-16, 7.853881411938061e-18, 1.1835915991023347e-17, 2.0453909214773423e-17, 2.3587769048563616e-17, 1.1631166237120518e-17, 2.1899486330968026e-18, -2.1899486357364444e-18, -1.1631166250802641e-17, -2.3587769071635952e-17, -2.0453909221029796e-17, -1.1856165708026205e-17, -7.828954259266239e-18, 6.040019505683942e-16, 4.1970508884153397e-14, 3.3781733085911057e-12, 9.486426595587287e-07, 0.05613507749534427, 0.0, 0.0, -0.05613408370714193, -1.2794701125396479e-06, -7.078042772601935e-12, -2.5408663004438704e-13, -1.349986594665392e-14, -5.098567319442461e-16, -5.5216239677461775e-17, -5.469391152579894e-17, -3.640821176422925e-17, 1.2115158954440651e-18, 6.8422992276707006e-18, 1.6878789490609117e-17, 4.0310759522754634e-17, 6.949531197011766e-17, 5.624690009997368e-17, 1.8086927924796042e-17, -1.8086927954114942e-17, -5.624690018248402e-17, -6.949531204285645e-17, -4.0310771409197356e-17, -1.6915919220563943e-17, -7.153670520932727e-18, -1.7982013432947435e-18, 3.628138165402309e-17, 5.417005645960232e-17, 5.512119984666902e-17, 5.507474574912037e-16, 1.4194653840189313e-14, 2.5962337991283825e-13, 7.1159569777284926e-12, 1.277667066421288e-06, 0.056134089966195344, 0.0]

expected["core_and_pfr_boundary"] = {}
expected["core_and_pfr_boundary"]["Pe"] = [1431.4713571971354, 1477.430239062269, 1454.2692561814526, 1431.4713571971351, 1387.9817563931322, 1304.786377716719, 1228.6187192142195, 1682.285465699333, 1682.285465699428, 1682.285465699396, 1682.2854656993827, 1682.285465699388, 1682.285465699388, 1682.2854656993827, 1682.285465699396, 1682.285465699428, 1682.285465699333, 1228.503659848467, 1303.6024761098568, 1386.0266657890575, 1429.4979057561075, 1452.2968431521017, 1475.4593988117485, 1429.4979057561075, 1586.4366665005425, 1598.9185239831402, 1592.6653676129774, 1586.4366665005432, 1580.1081421995577, 1572.8536176784476, 1563.0544637000783, 1548.217127091974, 1520.4981519064759, 1458.283634243855, 1332.993730725112, 1217.3657209849016, 1682.2854656993431, 1682.2854656994218, 1682.2854656994039, 1682.285465699388, 1682.2854656993893, 1682.2854656993893, 1682.285465699388, 1682.2854656994039, 1682.2854656994218, 1682.2854656993431, 1217.265986508058, 1330.9758419366894, 1454.990083664767, 1517.2539051871563, 1545.368054704179, 1560.463544728661, 1570.451164946677, 1577.8932498775546, 1584.146987400192, 1590.3275203244334, 1596.5321665333195, 1584.1469874001923]
expected["core_and_pfr_boundary"]["NVd+"] = [0.0, -0.04891661004628929, 0.0, -1.0832892161392212e-28, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 5.044458509139815e-38, 0.0, 0.0, 0.0, 0.0, 0.0, -2.5222292545699077e-38, 0.0, 0.0, 0.0, 0.0, 0.0, 0.048850808825448254, 0.0, 0.0, -0.053254327036182963, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.053175469070784735, 0.0]

expected["sol_ring"] = {}
expected["sol_ring"]["Pe"] = [1682.2850428999302, 1682.1950305562323, 1682.24003612604, 1682.2850428999302, 1682.2854642470334, 1682.2854656987595, 1682.2854656994118, 1682.2854656994448, 1682.28546569929, 1682.2854656993704, 1682.2854656993864, 1682.285465699388, 1682.285465699388, 1682.2854656993864, 1682.2854656993704, 1682.28546569929, 1682.2854656994448, 1682.2854656994118, 1682.2854656987613, 1682.2854642597472, 1682.285047641437, 1682.2403236599705, 1682.1956008675024, 1682.285047641437, 1682.2775007360954, 1682.074120088696, 1682.1758073387211, 1682.2775007360958, 1682.2849127743982, 1682.2854443415408, 1682.285465299302, 1682.2854656962627, 1682.2854656993652, 1682.2854656993395, 1682.285465699311, 1682.285465699419, 1682.2854656994334, 1682.2854656993175, 1682.2854656993766, 1682.285465699388, 1682.2854656993893, 1682.2854656993893, 1682.285465699388, 1682.2854656993766, 1682.2854656993175, 1682.2854656994334, 1682.285465699419, 1682.285465699311, 1682.2854656993395, 1682.2854656993668, 1682.2854656965658, 1682.2854653345162, 1682.2854459607229, 1682.2849458924168, 1682.2778136661593, 1682.1775060986, 1682.0772045119838, 1682.277813666159]
expected["sol_ring"]["NVd+"] = [0.0, -0.05613645476518425, -5.117057958823623e-07, -9.012997839556266e-13, -2.46140722394442e-15, -2.2880373461710244e-18, -9.176846722126705e-22, 3.495852214001808e-22, 6.148730445230089e-22, -1.1490229208316775e-21, -2.4452012288255863e-22, -1.4004862907472108e-23, 1.4004862907870665e-23, 2.445201228841631e-22, 1.1490229200789443e-21, -6.196148915788101e-22, -3.4791536081123753e-22, 9.217733664466817e-22, 2.275006709401404e-18, 2.437844573166114e-15, 8.987218043517249e-13, 5.084049970559749e-07, 0.05613646127106354, 0.0, 0.0, -0.056133961686815975, -1.3189208083107995e-06, -7.1504355317647455e-12, -2.378748081806358e-13, -1.02032489480432e-14, -2.373283980177778e-16, -2.5418495463519695e-18, -8.074307746581022e-21, 1.908426894030968e-21, -9.539727606645468e-22, -4.0778006514469444e-22, 2.938307375064416e-22, 6.018943241994416e-22, -1.1654170836126005e-21, -3.104273676618942e-22, -5.207143796679161e-23, 5.2071437966541005e-23, 3.1042736764852627e-22, 1.1654170832333571e-21, -6.033662892479291e-22, -2.9383073807575593e-22, 4.1161983715994495e-22, 9.509682687037171e-22, -1.928886559773305e-21, 7.065974569783289e-21, 2.3055573543901457e-18, 2.177584108890311e-16, 9.502690222080837e-15, 2.2573240005007884e-13, 6.929355445299712e-12, 1.2955479216735619e-06, 0.05613403263777415, 0.0]

# fmt: on

# Generate test data or run test
if gen_data:
    # Generate test data, print to console and fail test
    for region_name, ds in regions.items():
        print(f'expected["{region_name}"] = {{}}')
        print(f'expected["{region_name}"]["Pe"] = {ds["Pe"].values.tolist()}')
        print(f'expected["{region_name}"]["NVd+"] = {ds["NVd+"].values.tolist()}')
        print("")

    success = False
else:
    # Perform test
    failures = []
    for region_name, ds in regions.items():
        for variable in ["Pe", "NVd+"]:
            actual = ds[variable]
            reference = expected[region_name][variable]

            try:
                np.testing.assert_allclose(actual, reference, rtol=rtol, atol=atol)
            except AssertionError as e:
                failures.append(
                    {"region": region_name, "variable": variable, "error_msg": str(e)}
                )

    if len(failures) > 0:
        print("2D-production test failures:")
        success = False
        for f in failures:
            print(f"\n{f['region']} [{f['variable']}]:")
            print(f["error_msg"])

        exit(1)

    else:
        success = True
        if verbose:
            print("2D-production test: Passed")
        exit(0)
