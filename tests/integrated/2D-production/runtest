#!/usr/bin/env python3
from boututils.run_wrapper import shell, launch_safe, getmpirun
import numpy as np
import shutil
import zipfile
import hashlib
from pathlib import Path
import urllib.request
import xhermes

gen_data = False
verbose = False
rtol = 1e-6
atol = 1e-8

## Setup
this_dir = Path(__file__).parent
data_dir = this_dir / "data"
hermes_exec = this_dir.parent.parent.parent / "hermes-3"
output_path = data_dir / "BOUT.dmp.*.nc"

zipfile_path = this_dir / "test-2D-production.zip"
url = "https://zenodo.org/records/18623307/files/test-2D-production-2026-02-12.zip"
expected_hash = "167410a1768c2805acdd28895d4327fa448bc742107ddf82b9062c02800b0cbe"
expected_filenames = [
    "BOUT.restart.0.nc",
    "BOUT.restart.1.nc",
    "BOUT.restart.2.nc",
    "BOUT.restart.3.nc",
    "BOUT.restart.4.nc",
    "BOUT.restart.5.nc",
    "BOUT.restart.6.nc",
    "BOUT.restart.7.nc",
    "BOUT.restart.8.nc",
    "BOUT.restart.9.nc",
    "grid_test2.nc",
]


## Download files
tmp_path = zipfile_path.with_name(zipfile_path.name + ".tmp")

with urllib.request.urlopen(url, timeout=60) as response:
    if response.status != 200:
        raise RuntimeError(
            f"2D-Production test: download failed - HTTP {response.status}"
        )

    # Copy bits of the file from response to a temp file
    # This ensures no partial files are left if the download fails
    with open(tmp_path, "wb") as out_file:
        shutil.copyfileobj(response, out_file)

# Rename temp file with the correct name
tmp_path.replace(zipfile_path)

with zipfile.ZipFile(zipfile_path, "r") as zf:
    zip_contents = set(zf.namelist())
    try:
        # Extract only expected grids
        for filename in expected_filenames:
            if filename in zip_contents:
                zf.extract(filename, path=this_dir)

    except Exception as e:
        print("2D-Production test: extracting test grids failed:", e)

# Check hash
with open(zipfile_path, "rb") as f:
    file_hash = hashlib.sha256(f.read()).hexdigest()
# print(file_hash)

if file_hash != expected_hash:
    raise RuntimeError(
        "2D-Production test: downloaded zip file hash does not match expected value"
    )

if verbose:
    print("2D-Production test: downloaded and extracted files")

## Run test
if not Path("hermes-3").is_file():
    shell("ln -s ../../../hermes-3 hermes-3")

runcmd = getmpirun().split(" ")[0] + " --oversubscribe -np"

s, out = launch_safe("./hermes-3 -d data", runcmd=runcmd, nproc=10, pipe=True)

if s != 0:
    print(" => 2D-Production test failed: ")
    print(out)
    exit(1)

if verbose:
    print("2D-Production test: completed simulation")

# Load case
ds = xhermes.open_hermesdataset(
    datapath=output_path,
    gridfilepath=this_dir / "grid_test2.nc",
    keep_yboundaries=True,
    keep_xboundaries=True,
    geometry="toroidal",
).isel(t=-1)

ds = ds.hermes.extract_2d_tokamak_geometry()

if verbose:
    print("2D-Production test: loaded results")


# Testing at specific locations around the domain
m = ds.metadata
x_selection = slice(None)
regions = {}
regions["inner_lower_target"] = ds.isel(x=x_selection, theta=2)
regions["inner_upper_target"] = ds.isel(
    x=x_selection, theta=m["ny_innerg"] - m["MYG"] * 2 - 1
)
regions["outer_upper_target"] = ds.isel(x=x_selection, theta=m["ny_innerg"])
regions["outer_lower_target"] = ds.isel(x=x_selection, theta=-3)
regions["outer_midplane_a"] = ds.isel(
    x=x_selection, theta=int((m["jyseps2_2g"] - m["jyseps1_2g"]) / 2) + m["jyseps1_2g"]
)
regions["sol_boundary"] = ds.isel(x=-3, theta=slice(None))
regions["core_and_pfr_boundary"] = ds.isel(x=0, theta=slice(None))
regions["sol_ring"] = ds.isel(x=m["ixseps1"], theta=slice(None))

# Expected results
# The below line disables Ruff formatting for the data to keep it readable
# fmt: off

expected = {}
expected["inner_lower_target"] = {}
expected["inner_lower_target"]["ddt(Pe)"] = [50169842.915966116, -742855675.4794323, -4304610500.977398, -4269050932.5855165, -4228674676.210835, -4200903373.67738, -4183474168.003037, -4175598368.7199407, -4179006264.642877, -4197874195.482857, -4228255432.5507054, -4273019055.0230823, -4351670040.240914, -4486907748.407297, -4719689979.352699, -5123014172.7427225, -5776594395.951018, -6640950414.125895, -2044918777.294562, -1751512025.553562]
expected["inner_lower_target"]["ddt(NVd+)"] = [-2876024671.3148937, -2873149851.0952034, -97627.24515082625, -97596.10881438255, -96747.42216983506, -96058.20172352587, -95580.74146986139, -95337.42157880533, -95409.4516965011, -95933.62263307042, -96904.00709183833, -98483.08222451406, -101188.58937143938, -105856.29588211968, -113930.86099818879, -127806.79294670641, -149513.45287817574, -176445.0775059831, -8565286662.518977, -8921649233.315369]
expected["inner_lower_target"]["ddt(Pd)"] = [21836315520.143723, 22082816688.865986, 18190469.274424557, 17948853.576704103, 17791042.988853484, 17663024.41288847, 17574366.530407734, 17529206.019246034, 17542615.353626296, 17639987.65725322, 17819139.77664536, 18106904.15917843, 18601958.742566384, 19462011.869156286, 20956442.92744598, 23532818.355522882, 27576966.034471735, 32644741.10815459, 10887934814.693073, 10878707129.671007]

expected["inner_upper_target"] = {}
expected["inner_upper_target"]["ddt(Pe)"] = [52215856.14210324, -738542113.7029359, -4295680569.378687, -4254854593.7457, -4210475741.3917747, -4180073772.8309536, -4161215887.327326, -4152878037.243077, -4156717430.5777445, -4176810236.993308, -4209051008.52271, -4256421928.8867016, -4338737355.746452, -4479364881.237449, -4721023362.545324, -5136345175.717079, -5806409535.004168, -6691897361.153384, -2074311113.497937, -1778227904.538783]
expected["inner_upper_target"]["ddt(NVd+)"] = [57060.94641390822, 60782.6230252063, 97345.51891890798, 97141.4718455331, 96166.93448499602, 95393.83213094233, 94870.06212120554, 94610.97508282008, 94695.22768583578, 95256.3620429819, 96284.12593017981, 97945.14397348482, 100767.6307278337, 105610.18584169116, 113976.11358606118, 128239.62904524893, 150445.3899075781, 177963.87579615065, 39848.682756637994, 27058.443505674568]
expected["inner_upper_target"]["ddt(Pd)"] = [21807732504.08248, 22052084780.78892, 18135253.85223576, 17864010.10333657, 17682866.957870346, 17539302.573226307, 17442067.17032005, 17393989.851304043, 17409665.47505044, 17513880.496879753, 17703670.654710837, 18006681.61086987, 18523473.83124723, 19415961.172785755, 20964462.836146064, 23612977.991854113, 27750594.122173775, 32929156.6321018, 10867946521.417189, 10858779899.03975]

expected["outer_upper_target"] = {}
expected["outer_upper_target"]["ddt(Pe)"] = [-7888216570.658029, -7707678102.420513, -9412473561.884418, -9275440101.404741, -9193339950.465391, -9123757650.405659, -9058450100.764236, -8996130090.528502, -8937613552.136099, -8883171755.575182, -8829319775.75638, -8764225164.695337, -8672064724.34504, -8545930346.02085, -8403354584.689, -8301956732.311143, -8328685916.435756, -8557936381.653517, -3257354246.525731, -3575104425.819322]
expected["outer_upper_target"]["ddt(NVd+)"] = [-6065684067.328326, -6085237079.949878, -262269.2262145322, -259561.30234720325, -257047.6126288672, -254749.35501929978, -252631.5190403847, -250670.14606659906, -248850.16804359324, -247153.37422000998, -245458.76061251448, -243391.8981141229, -240464.05845339963, -236518.42478053496, -232158.43771635648, -229194.76718339944, -230691.13579824398, -238323.34972727488, -59402372123.20294, -76278631822.84929]
expected["outer_upper_target"]["ddt(Pd)"] = [23753081477.59546, 24012615571.627995, 49576843.98608159, 48437757.813150294, 47954095.79903302, 47514540.65513018, 47109677.06419733, 46734872.23902638, 46387210.17803637, 46063134.65969933, 45731353.932762966, 45306141.11046701, 44723008.87045321, 43958855.19129352, 43123926.923684165, 42557834.35809563, 42838374.91539005, 44312267.485659, 11272203233.080938, 11265971230.645535]

expected["outer_lower_target"] = {}
expected["outer_lower_target"]["ddt(Pe)"] = [-7694109145.468697, -7517780365.272035, -9263493522.018179, -9141133486.093513, -9064502611.052725, -8993850748.748005, -8927443661.877653, -8866030518.162954, -8809253308.58338, -8755049599.731445, -8700966879.578524, -8636025412.177845, -8544654827.76504, -8421849727.331336, -8289337451.252191, -8210317383.113926, -8273765158.831274, -8530867776.9949875, -3247671027.781059, -3588572538.909964]
expected["outer_lower_target"]["ddt(NVd+)"] = [62824.6449503896, 71241.22252976603, 257814.38174886905, 255175.1901993391, 252721.5049722933, 250468.60787386654, 248391.07712053123, 246473.6045948659, 244685.67713085903, 242960.65867550782, 241230.79209562446, 239160.1573248301, 236281.92163091915, 232491.9335721532, 228476.6976661839, 226227.41003335387, 228917.99602217565, 237996.80525434585, 45014.94475880986, 28138.620223711063]
expected["outer_lower_target"]["ddt(Pd)"] = [23720518128.85167, 23977216951.194283, 48708391.49728688, 47598988.0003351, 47127431.73031908, 46696937.34291152, 46300123.93269432, 45934012.42848872, 45592742.052161366, 45263585.442025974, 44925656.68042244, 44501104.96963591, 43928731.697782636, 43195168.06133335, 42426390.63783815, 41995993.82862742, 42502504.05957557, 44249743.69620499, 11178840216.935766, 11172799204.850418]

expected["outer_midplane_a"] = {}
expected["outer_midplane_a"]["ddt(Pe)"] = [575756628483.8103, 575755524054.7208, 2597004.6362345833, -113.83532147348261, -116.55449960403, -116.35877336983316, -116.24786244306465, -116.15353137627382, -116.05772447274411, -115.9602269146965, -115.9619283616361, -116.01750285606023, -116.05170994925447, -116.07406960127224, -116.16370023478372, -117.60279317075285, -178.76209409945446, -3921408.409104116, 6442716958.372204, 114821715570.57205]
expected["outer_midplane_a"]["ddt(NVd+)"] = [9892.902938138688, 9872.980687745128, 7.516862440808798e-10, -7.363870831318799e-09, -5.380868674683838e-09, -4.106812615078531e-09, -3.6316780771438042e-09, -3.4541920842725523e-09, -3.2919439417301064e-09, -3.08602332608723e-09, -3.2006428115706275e-09, -3.554140313817576e-09, -3.956195362035334e-09, -4.530891370960315e-09, -5.816364956170702e-09, -1.3326898038483898e-08, -6.033941980422982e-08, 0.0013857443892516953, 42259.28756997348, 42271.908771506314]
expected["outer_midplane_a"]["ddt(Pd)"] = [5292523629377.751, 5292533459835.6045, 451.91368053529993, 451.7162716723981, 451.46884270948385, 451.3547026437219, 451.2884224190179, 451.25271170076775, 451.23532015867426, 451.2260371664728, 451.2193464383088, 451.21147628876923, 451.1989088006843, 451.16857351019905, 450.90476946603195, 444.7080808000384, 357.843895729337, 72858.94475091004, 59831512677.63727, 1055989488724.8794]

expected["sol_boundary"] = {}
expected["sol_boundary"]["ddt(Pe)"] = [7040141235.147225, 14140538343.747286, -6640950414.125895, -1282060926.6715412, -1180264929.8848903, -1029786039.2944055, -785680837.0799059, -79814022.0458095, -3537135.417580988, -2456987.4483396276, -2829377.6537651243, -2918133.444118899, -2918133.311341702, -2829380.674684653, -2458511.521930327, -3598863.562132425, -81813044.80530596, -799760190.3422353, -1041553978.9698263, -1188583258.0073864, -1287683040.216224, -6691897361.153384, 13342852468.832125, 6992989305.542808, 6967164514.063354, 17445287890.00271, -8557936381.653517, -1306078018.6287196, -1264181043.3350003, -1188130262.1107335, -1096259114.0235438, -968011790.8351407, -799510946.298836, -599978110.8556144, -417003735.25202817, -237531805.7588513, -38093678.30852585, -2988873.8186192755, -2648684.0504526813, -3528399.383291522, -3921408.409104116, -3921417.195404852, -3528649.4244218385, -2655193.446846675, -3138074.962289612, -41081513.56561465, -252251960.3728706, -434734466.6373385, -616234361.1343075, -811343317.1213229, -979110939.0957397, -1088832034.6300757, -1222844275.3843794, -1214950885.8243492, -1351984281.5045824, -8530867776.9949875, 15900805986.985672, 6919455690.431742]
expected["sol_boundary"]["ddt(NVd+)"] = [275459.01118146436, 1704752.5454030265, -176445.0775059831, -141.09389337975318, -7.7811286275811575, -6.4415242829522015, -3.9051442956372773, -0.521161386845479, -0.016945849564654333, 0.001437418381507324, 0.0008860067401369189, 0.00016811755074639233, -0.0001681188321080024, -0.0008857049605294921, -0.001423649375380335, 0.017546240318892584, 0.5359481639121575, 4.01648624789505, 6.544817534536856, 7.912786522559894, 144.28369367759862, 177963.87579615065, 18595795072.026257, -145528.2164985979, 462666.4878914047, 1760040.3901090308, -238323.34972727488, -293.9930774564742, -11.653238706422528, -9.725511285949768, -8.01409665210771, -6.280045987507114, -4.3992058141037, -2.66798469973487, -1.7922715307878367, -0.8237714153623368, -0.14884319088940293, -0.006551760488562846, 0.004940376176582682, 0.004300021739169993, 0.0013857443892516953, -0.0013856902150592085, -0.004298206156997065, -0.004898159422559628, 0.007491224927109545, 0.16151016811858276, 0.8850514234435518, 1.8905191662388943, 2.7616137148399407, 4.500051151139792, 6.371985584974742, 8.086408756015915, 9.784939435319394, 11.669829976787133, 295.5304344902548, 237996.80525434585, 105583922484.45906, -333289.4850881328]
expected["sol_boundary"]["ddt(Pd)"] = [65349002215.10133, 140383233118.26758, 32644741.10815459, 45362.0290742574, 22811.85939396393, 20352.456139041868, 21971.359822925016, 22038.481543458103, 30101.84964199366, 45128.0532666458, 52716.71588147038, 54345.78602480599, 54345.78602461487, 52716.71588175693, 45128.05326680033, 30101.84982856406, 22038.405025115306, 21958.502099063087, 20327.13768221985, 22757.485075938486, 45842.8734614881, 32929156.6321018, 140371582824.375, 64919308022.94629, 64679455342.897156, 139683138589.14505, 44312267.485659, 53175.812014302304, 26907.69384608087, 25683.913809341524, 24561.081284585758, 23489.17183251592, 21756.266968064854, 19069.07462592822, 18027.4153368496, 19238.420799452793, 19783.388158642225, 36036.30912740375, 57412.40041709283, 74652.41641485802, 72858.94475091004, 72858.94475079331, 74652.41641547697, 57412.40514948351, 36036.26858586201, 19116.899998517027, 19224.445391664118, 17992.16760562609, 18997.130203993438, 21613.497276310576, 23269.628209328464, 24273.894598014514, 25331.178345498472, 26492.861511700972, 53081.529768502325, 44249743.69620499, 139684672279.79413, 64244509466.508705]

expected["core_and_pfr_boundary"] = {}
expected["core_and_pfr_boundary"]["ddt(Pe)"] = [4401735780.644753, 3781260489.668156, 50169842.915966116, 4401735780.644753, 41017625054.83577, 71093990935.7456, 113892218382.04913, 575730061515.1178, 575773277214.8667, 575755894072.7156, 575753872919.1816, 575757285447.7184, 575757285447.7114, 575753872919.1987, 575755894072.6625, 575773277214.9519, 575730061514.8639, 114135803299.59569, 71684838352.73232, 41511483358.17054, 4388460338.927334, 52215856.14210324, 3775253755.951538, 4388460338.927334, 4577586300.011606, 4147191031.878836, -7888216570.658029, 4577586300.011606, 16777528519.193655, 17185789038.54098, 17707127931.136726, 18439411716.73761, 20022781922.38959, 26227315732.271034, 55758387906.4238, 113139299374.0793, 575738667265.9988, 575768927481.4447, 575760585970.8083, 575753172047.028, 575756628483.8103, 575756628483.8054, 575753172047.0249, 575760585970.8099, 575768927481.5029, 575738667265.7694, 113206801920.31429, 56606525884.27188, 26728144474.001366, 20310385801.945442, 18644665149.06061, 17871592244.051006, 17320271744.489964, 16887340609.922747, 4555609168.747308, -7694109145.468697, 4140164210.1662235, 4555609168.747308]
expected["core_and_pfr_boundary"]["ddt(NVd+)"] = [401931.394528231, 1346000.5386743643, -2876024671.3148937, 401931.3945293199, 56004.72160616195, 51138.100809666554, 48107.80953291119, 10513.935875403076, 10115.586826659057, 9713.265801604444, 9843.694241517449, 9898.074172551796, 9859.675904151938, 9914.055872705663, 10044.484064385648, 9642.162696660991, 9243.814540488596, 48084.58752581645, 50977.82526906957, 52561.01058093079, -286392.3886969619, 57060.94641390822, 2879799566.681926, -286392.3886958913, 754508.4418491187, 1446295.724715992, -6065684067.328326, 754508.4418556045, 66618.89781705932, 61770.47231289863, 61354.91524994714, 60758.67116178973, 59690.37228908758, 57242.435852334675, 52270.70549622341, 47649.6342675114, 10492.828231513811, 10120.588955337362, 9733.242495670092, 9810.221545610373, 9892.902938138688, 9864.847115203529, 9947.528518572148, 10024.507280632259, 9637.160627873533, 9264.922080443554, 47662.510865867254, 52021.69021530314, 56809.66508245292, 59234.39902420321, 60350.853553427536, 60926.142183912445, 61284.85659211099, 56903.9046010256, -618775.1226062799, 62824.6449503896, 6049712359.167171, -618775.1226003006]
expected["core_and_pfr_boundary"]["ddt(Pd)"] = [41098124600.17293, 125097197434.18297, 21836315520.143723, 41098605188.44764, 377643067017.50616, 654080254800.7358, 1047446312148.4849, 5292279445000.359, 5292676649633.599, 5292516880260.275, 5292498302747.537, 5292529667583.303, 5292529667813.981, 5292498302347.051, 5292516878455.151, 5292676652206.609, 5292279451474.889, 1049685144217.6357, 659510838614.3738, 382182219897.6511, 40982550925.35266, 21807732504.08248, 124941414627.81859, 40983020178.99683, 42717394634.45088, 134272802421.49084, 23753081477.59546, 42717482672.59537, 154847418886.24548, 158600324588.43085, 163392153717.38083, 170122719210.92416, 184675758282.62033, 241702727703.05173, 513128023255.7356, 1040526102033.2341, 5292358542271.578, 5292636670647.629, 5292560004058.11, 5292491861002.391, 5292523629377.751, 5292523629492.157, 5292491860432.495, 5292560002772.686, 5292636672863.769, 5292358548086.904, 1041146529698.1555, 520923410103.6846, 246305934748.02472, 187319178146.99268, 172009241865.39996, 164903784239.79977, 159836447485.78, 155857068650.72516, 42522723630.14901, 23720518128.85167, 134094280626.4646, 42522800661.5887]

expected["sol_ring"] = {}
expected["sol_ring"]["ddt(Pe)"] = [4924768510.334232, 10126223691.625757, -4228255432.5507054, -1173863782.7429502, -824967630.4326626, -137025853.70474637, -1030458.0007741455, -2783.581170796749, -159.70345229589833, -117.94917120621747, -116.12630706106638, -117.18229681354394, -117.1822424561133, -116.12674609967377, -117.95352963039417, -159.9300581099448, -2816.801582635106, -1042276.5819390481, -137490682.63978952, -823701300.0104997, -1172467097.030372, -4209051008.52271, 9784031216.160055, 4922923618.414623, 4415507229.193756, 18260878607.34742, -8829319775.75638, -1365750579.90581, -1311741384.9340029, -1229949864.804348, -1106724846.8120773, -915700236.1663383, -634193894.7503301, -265111477.64243332, -16596479.594702749, -59261.38492446941, -213.04127409711643, -136.1277115965021, -117.25122342667686, -115.42407064616242, -115.9619283616361, -115.9619283619933, -115.42407427999724, -117.25131875677855, -136.12900783387107, -212.83302636460016, -59192.97459130756, -16451402.419650288, -261877037.76901412, -627919263.4923383, -909371867.343901, -1101928995.2450984, -1224959557.67431, -1313949098.4879217, -1359396895.2632105, -8700966879.578524, 16347076657.646313, 4418783702.973036]
expected["sol_ring"]["ddt(NVd+)"] = [481103.57474753703, 1635957.635092183, -96904.00709183833, -43.777309052184414, -4.506304504218375, -0.7669615471030942, -0.018846193820259455, -6.871246685834806e-05, -3.3926918868385005e-07, -9.344258639414873e-08, -1.6779368403983198e-08, -5.349329627288174e-10, 5.345114303196986e-10, 1.67813337498873e-08, 9.348237955993853e-08, 3.438830733923636e-07, 6.948508208175357e-05, 0.018981455965268224, 0.7676141901774273, 4.511586774048646, 43.796304490652645, 96284.12593017981, 3434099610.939183, -345296.6860083257, 849327.1730448692, 1777637.3517061705, -245458.76061251448, -297.26923846364855, -11.764114702509278, -9.615929436161963, -7.5449037083606605, -5.307379343473938, -2.9591533878167016, -0.9782639596803325, -0.10215470382619038, -0.0012135140896611777, -2.83981822373502e-06, 3.110446297805269e-08, -9.388610740353654e-08, -2.2506655178872017e-08, -3.2006428115706275e-09, 3.200642812142992e-09, 2.2506655221524897e-08, 9.38865804392116e-08, -3.133766296374842e-08, 2.829354345885942e-06, 0.0012057347156259244, 0.10087478375901718, 0.9643158274301241, 2.9173689099483253, 5.244726508054603, 7.4737277902961905, 9.527255637578047, 11.618020357715833, 288.1108360720507, 241230.79209562446, 7101176351.234636, -704805.9977755407]
expected["sol_ring"]["ddt(Pd)"] = [45905670908.50517, 141273650203.8679, 17819139.77664536, 6448.3380439642, 496.8962676725002, 547.6168449885428, 436.205601894683, 411.21693190143304, 521.401313751311, 466.7594601174724, 454.37718776142185, 453.4784504761168, 453.47845047701423, 454.37718776154514, 466.7594601088079, 521.4012716986492, 411.11994645476705, 436.43056703416465, 547.2836768487265, 496.5726739387792, 6455.854096840407, 17703670.654710837, 141282484489.45425, 45895696497.0869, 41228214033.010574, 139914948931.22067, 45731353.932762966, 27016.36909169447, 381.27118838326726, 452.9725661775938, 455.797562329906, 458.54061217939557, 463.75961098436846, 489.32603293427985, 507.51815050181455, 430.04852152387286, 418.6476147354603, 499.71491715861356, 462.43726329054255, 453.06020488910053, 451.2193464383088, 451.21934644026425, 453.06020488871263, 462.43726327965396, 499.7148423081359, 418.4749141786135, 430.30165079475285, 507.5327498633528, 489.23856994219494, 463.61847377781004, 458.4279809179424, 455.7654488992944, 452.9399719046298, 381.2260874535108, 26597.39581031003, 44925656.68042244, 139948476995.44907, 41265909080.1113]

# fmt: on

# Generate test data or run test
if gen_data:
    # Generate test data, print to console and fail test
    for region_name, ds in regions.items():
        print(f'expected["{region_name}"] = {{}}')
        print(f'expected["{region_name}"]["ddt(Pe)"] = {ds["ddt(Pe)"].values.tolist()}')
        print(
            f'expected["{region_name}"]["ddt(NVd+)"] = {ds["ddt(NVd+)"].values.tolist()}'
        )
        print(f'expected["{region_name}"]["ddt(Pd)"] = {ds["ddt(Pd)"].values.tolist()}')
        print("")

else:
    # Perform test
    failures = []
    for region_name, ds in regions.items():
        for variable in ["ddt(Pe)", "ddt(NVd+)"]:
            actual = ds[variable]
            reference = expected[region_name][variable]

            try:
                np.testing.assert_allclose(actual, reference, rtol=rtol, atol=atol)
            except AssertionError as e:
                failures.append(
                    {"region": region_name, "variable": variable, "error_msg": str(e)}
                )

    if len(failures) > 0:
        print("2D-production test failures:")
        for f in failures:
            print(f"\n{f['region']} [{f['variable']}]:")
            print(f["error_msg"])

        exit(1)

    else:
        if verbose:
            print("2D-production test: Passed")
        exit(0)
