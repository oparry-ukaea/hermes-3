from boututils.run_wrapper import shell, launch_safe, getmpirun
import numpy as np
import shutil
import zipfile
import hashlib
from pathlib import Path
import urllib.request
import xhermes

gen_data = False
verbose = False
rtol = 1e-6
atol = 1e-8

## Setup
this_dir = Path(__file__).parent
data_dir = this_dir / "data"
hermes_exec = this_dir.parent.parent.parent / "hermes-3"
output_path = data_dir / "BOUT.dmp.*.nc"

zipfile_path = this_dir / "Hypnotoad_examples.zip"
url = "https://zenodo.org/records/18301171/files/test-2D-production-v1.zip"
expected_hash = "b8e2be76791fad1fe7fe8c8734b3020eb63e7da5d69a4fafdf7c9a4695785ff3"
expected_filenames = [
    "BOUT.restart.0.nc",
    "BOUT.restart.1.nc",
    "BOUT.restart.2.nc",
    "BOUT.restart.3.nc",
    "BOUT.restart.4.nc",
    "BOUT.restart.5.nc",
    "BOUT.restart.6.nc",
    "BOUT.restart.7.nc",
    "BOUT.restart.8.nc",
    "BOUT.restart.9.nc",
    "grid_test2.nc"
    ]


## Download files
tmp_path = zipfile_path.with_name(zipfile_path.name + ".tmp")

with urllib.request.urlopen(url, timeout=60) as response:
    if response.status != 200:
        raise RuntimeError(f"2D-Production test: download failed - HTTP {response.status}")
    
    # Copy bits of the file from response to a temp file
    # This ensures no partial files are left if the download fails
    with open(tmp_path, "wb") as out_file:
        shutil.copyfileobj(response, out_file)

# Rename temp file with the correct name
tmp_path.replace(zipfile_path)

with zipfile.ZipFile(zipfile_path, "r") as zf:

    zip_contents = set(zf.namelist())
    try:
        # Extract only expected grids
        for filename in expected_filenames:
            if filename in zip_contents:
                zf.extract(filename, path=this_dir)

    except Exception as e:
        print("2D-Production test: extracting test grids failed:", e)

# Check hash
with open(zipfile_path, "rb") as f:
    file_hash = hashlib.sha256(f.read()).hexdigest()
    print(file_hash)

if file_hash != expected_hash:
    raise RuntimeError("2D-Production test: downloaded zip file hash does not match expected value")

if verbose:
    print("2D-Production test: downloaded and extracted files")

## Run test
if not Path("hermes-3").is_file():
  shell("ln -s ../../../hermes-3 hermes-3")

runcmd = getmpirun().split(" ")[0] + " --oversubscribe -np"

s, out = launch_safe("./hermes-3 -d data", runcmd = runcmd, nproc=10, pipe=True)

if s != 0:
  print(" => 2D-Production test failed: ")
  print(out)
  exit(1)

if verbose:
    print("2D-Production test: completed simulation")

# Load case
ds = xhermes.open_hermesdataset(
    datapath = output_path,
    gridfilepath = this_dir / "grid_test2.nc",
    keep_yboundaries = True,
    keep_xboundaries = True,
    geometry = "toroidal"
    ).isel(t=-1)

ds = ds.hermes.extract_2d_tokamak_geometry()

if verbose:
    print("2D-Production test: loaded results")


# Testing at specific locations around the domain
m = ds.metadata
x_selection = slice(None)
regions = {}
regions["inner_lower_target"] = ds.isel(x = x_selection, theta = 2)
regions["inner_upper_target"] = ds.isel(x = x_selection, theta = m["ny_innerg"] - m["MYG"] * 2 -1)
regions["outer_upper_target"] = ds.isel(x = x_selection, theta = m["ny_innerg"])
regions["outer_lower_target"] = ds.isel(x = x_selection, theta = -3)
regions["outer_midplane_a"] = ds.isel(x = x_selection, theta = int((m["jyseps2_2g"] - m["jyseps1_2g"]) / 2) + m["jyseps1_2g"])
regions["sol_boundary"] = ds.isel(x = -3, theta = slice(None))
regions["core_and_pfr_boundary"] = ds.isel(x = 0, theta = slice(None))
regions["sol_ring"] = ds.isel(x = m["ixseps1"], theta = slice(None))

# Expected results
expected = {}
expected["inner_lower_target"] = {}
expected["inner_lower_target"]["Pe"] = [1454.0042394661134, 1454.0042394661134, 1681.933037988994, 1681.9359043085508, 1681.9385648986674, 1681.940391544095, 1681.9416183684464, 1681.9422494446703, 1681.9420911867353, 1681.9407908170201, 1681.9383733264822, 1681.9344544920773, 1681.9277796071935, 1681.916419131515, 1681.8971926132997, 1681.8650958434412, 1681.8169300518691, 1681.759856418861, 686.110329745551, 686.1103297455512]
expected["inner_lower_target"]["NVd+"] = [0.0, 4.450604483773448e-06, -5.148278469276755e-06, -5.146412234162944e-06, -5.101192243760065e-06, -5.06449001488656e-06, -5.039071156326955e-06, -5.026119172644559e-06, -5.029953440300171e-06, -5.0578561753207725e-06, -5.109517527362631e-06, -5.1936035574484716e-06, -5.337735642906337e-06, -5.5865861032946236e-06, -6.017621615046927e-06, -6.759994972089835e-06, -7.925544692919247e-06, -9.378956826420642e-06, 3.826348414896429e-06, -4.5436442924096e-22]

expected["inner_upper_target"] = {}
expected["inner_upper_target"]["Pe"] = [1452.0327165056121, 1452.0327165056121, 1681.933783236581, 1681.9371095316355, 1681.940119271555, 1681.94218523685, 1681.9435471838142, 1681.9442262857006, 1681.9440353053121, 1681.9426295601183, 1681.9400478253015, 1681.935896655761, 1681.928898232003, 1681.9170755760506, 1681.897123459542, 1681.8641399549517, 1681.8149445641582, 1681.756761621194, 684.7530140412325, 684.7530140412324]
expected["inner_upper_target"]["NVd+"] = [0.0, -4.431696335712523e-06, 5.133369034561864e-06, 5.122282329703183e-06, 5.070366163565207e-06, 5.0292029820725595e-06, 5.001322426746161e-06, 4.987532835321659e-06, 4.992016840377594e-06, 5.021883151366644e-06, 5.076592651706649e-06, 5.165032874478142e-06, 5.315383948152062e-06, 5.5735410837313275e-06, 6.02012443665103e-06, 6.783276729324838e-06, 7.975801420152552e-06, 9.461274326004932e-06, -3.852302698731222e-06, 0.0]

expected["outer_upper_target"] = {}
expected["outer_upper_target"]["Pe"] = [1592.1148063733733, 1592.1148063733729, 1681.587491713105, 1681.5944776675228, 1681.5992622335916, 1681.6036437316097, 1681.6076944348442, 1681.6114604239506, 1681.6149688449163, 1681.6182528852905, 1681.6215450476805, 1681.625577559673, 1681.6313261445323, 1681.639150154393, 1681.6479344430172, 1681.6541823534521, 1681.6518696038363, 1681.6376317907861, 713.8719607780197, 713.8719607780199]
expected["outer_upper_target"]["NVd+"] = [0.0, 1.3319840616824268e-05, -1.4068380799676519e-05, -1.3916795106307702e-05, -1.3778394204654971e-05, -1.365192220084065e-05, -1.3535433130180929e-05, -1.3427595967051488e-05, -1.332757196996397e-05, -1.3234351959098982e-05, -1.3141283989206976e-05, -1.3027815656994607e-05, -1.2867162590499292e-05, -1.2650813846680058e-05, -1.241194648874974e-05, -1.224968255902298e-05, -1.2331519965278468e-05, -1.2749571317335762e-05, 5.41232029024789e-06, 0.0]

expected["outer_lower_target"] = {}
expected["outer_lower_target"]["Pe"] = [1589.7840825034516, 1589.7840825034516, 1681.5959275504383, 1681.6027492944447, 1681.607436080524, 1681.6117524646481, 1681.6157486106017, 1681.6194521692712, 1681.6229200751775, 1681.626279660724, 1681.6296613338873, 1681.633726987283, 1681.63941460818, 1681.6469751241304, 1681.6551336847622, 1681.6600240960763, 1681.6553884659124, 1681.6383386361815, 707.3816082294011, 707.3816082294009]
expected["outer_lower_target"]["NVd+"] = [0.0, -1.3068231952786926e-05, 1.3822937261697799e-05, 1.3675328670359146e-05, 1.3540355635593881e-05, 1.3416491924589425e-05, 1.3302322079020349e-05, 1.319699218477698e-05, 1.3098816287466853e-05, 1.300412885178694e-05, 1.2909209037930008e-05, 1.2795635285101989e-05, 1.2637845062472748e-05, 1.2430213778040825e-05, 1.2210415849981488e-05, 1.2087346897179825e-05, 1.2234472287682885e-05, 1.2731666882608455e-05, -5.355579013597307e-06, 1.81745771696384e-21]

expected["outer_midplane_a"] = {}
expected["outer_midplane_a"]["Pe"] = [1682.2854656939223, 1682.2856012596621, 1682.2856012596621, 1682.2854656939228, 1682.285465693906, 1682.2854656939078, 1682.285465693909, 1682.2854656939096, 1682.28546569391, 1682.2854656939103, 1682.2854656939103, 1682.2854656939103, 1682.2854656939107, 1682.2854656939112, 1682.285465693912, 1682.2854656939137, 1682.2854656936247, 1682.2852610253697, 1079.4126452275216, 1079.4126452275216]
expected["outer_midplane_a"]["NVd+"] = [0.0, -7.784257417444708e-21, 7.784257417444708e-21, -3.153994686856107e-20, -3.033048422864029e-20, -2.5643569552309713e-20, -2.4383539572688642e-20, -2.4627541554911744e-20, -2.505479052582373e-20, -2.5309808073865668e-20, -2.58826022056111e-20, -2.6801402518172965e-20, -2.816068448235204e-20, -3.0453862806186485e-20, -3.4629624457408526e-20, -4.410100336302865e-20, -3.1435058402449187e-20, 9.042981389941154e-15, -5.802290900955844e-15, 0.0]

expected["sol_boundary"] = {}
expected["sol_boundary"]["Pe"] = [1682.1564290877889, 1681.3633772429512, 1681.759856418861, 1682.1564290877889, 1682.2296581071064, 1682.2620331632806, 1682.2789647917625, 1682.2852675808451, 1682.2853807030735, 1682.2853394837673, 1682.28531803319, 1682.2853134178167, 1682.285313417817, 1682.2853180331954, 1682.285339483188, 1682.2853806473772, 1682.2852609328156, 1682.2786501823173, 1682.2612542861834, 1682.2285477486046, 1682.155301876037, 1681.756761621194, 1681.358315789461, 1682.1553018760374, 1682.1142501993086, 1681.1611484296345, 1681.6376317907861, 1682.1142501993086, 1682.1748856119643, 1682.2153152866058, 1682.2433150424524, 1682.2625912633819, 1682.275018783186, 1682.281589852343, 1682.2840702686779, 1682.2850780786077, 1682.2853920348423, 1682.2853903008127, 1682.2853304013618, 1682.2852816153993, 1682.2852610253697, 1682.2852610253722, 1682.2852816154543, 1682.2853304022362, 1682.2853902489223, 1682.2853895941541, 1682.285035318421, 1682.2839265481748, 1682.2812850011144, 1682.274450961507, 1682.2617575287863, 1682.2423134150388, 1682.2143577332872, 1682.1742487755716, 1682.1141014136408, 1681.6383386361815, 1681.1627104216634, 1682.1141014136404]
expected["sol_boundary"]["NVd+"] = [0.0, -0.05611214917085059, -9.378956826420642e-06, -1.125501892645795e-09, -1.1018265462859716e-10, -4.899545517775163e-11, -1.2857678938128442e-11, -8.132921560220692e-13, -5.253785977154217e-16, 1.1688331299416998e-14, 5.817732191312576e-15, 1.095349537746929e-15, -1.095350282937733e-15, -5.817668001356878e-15, -1.16831865291948e-14, 1.0468592834267149e-15, 8.533073549949863e-13, 1.3428664360327413e-11, 5.0575469408101623e-11, 1.1235739042327211e-10, 1.14964512999245e-09, 9.461274326004932e-06, 0.056111907316254137, 0.0, 0.0, -0.05610358285143245, -1.2749571317335762e-05, -2.214866201565011e-09, -2.3080679177748274e-10, -1.3998438572835174e-10, -8.201371381110948e-11, -4.399102319093e-11, -1.9996658488129518e-11, -7.490969140188039e-12, -2.8330519785581326e-12, -6.942686031771334e-13, -6.143601351854176e-14, 1.7782557988965828e-14, 3.4686304682716545e-14, 2.813059907185281e-14, 9.042981389941154e-15, -9.04299508044735e-15, -2.8130778728077507e-14, -3.46780362269202e-14, -1.7477595492157772e-14, 7.040804855669117e-14, 7.78337262782938e-13, 3.119897713076326e-12, 8.04359645510525e-12, 2.1052763632243953e-11, 4.557786437455833e-11, 8.399027879551917e-11, 1.420473780635535e-10, 2.3238627049500056e-10, 2.22544529204676e-09, 1.2731666882608455e-05, 0.056103632929658795, 0.0]

expected["core_and_pfr_boundary"] = {}
expected["core_and_pfr_boundary"]["Pe"] = [1431.4201323418727, 1476.9446653838902, 1454.0042394661134, 1431.4201323418722, 1387.9760706926015, 1304.7860112070978, 1228.618546361692, 1682.2854656931859, 1682.285465694365, 1682.2854656939512, 1682.2854656938273, 1682.2854656938864, 1682.2854656938864, 1682.2854656938273, 1682.2854656939512, 1682.285465694365, 1682.2854656931859, 1228.503486981592, 1303.6021091799564, 1386.0210017200484, 1429.4469347065683, 1452.0327165056121, 1474.9753618769155, 1429.4469347065683, 1586.272419541873, 1597.9787112515016, 1592.1148063733733, 1586.2724195418725, 1579.9962340621003, 1572.7840125298562, 1563.015862703922, 1548.199731934811, 1520.4931905723888, 1458.2828399584992, 1332.9934715860504, 1217.3655574930865, 1682.2854656933246, 1682.2854656942784, 1682.2854656940372, 1682.285465693874, 1682.2854656939223, 1682.2854656939223, 1682.285465693874, 1682.2854656940372, 1682.2854656942784, 1682.2854656933246, 1217.2658230008703, 1330.9755852396838, 1454.9893092200118, 1517.2491071327645, 1545.351148029422, 1560.425838980838, 1570.3828879023997, 1577.7830107663394, 1583.9842654651752, 1589.7840825034516, 1595.6051357865638, 1583.9842654651752]
expected["core_and_pfr_boundary"]["NVd+"] = [0.0, -0.04890894329417926, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -1.614226722924741e-36, 0.0, 0.0, 0.0, 0.0, 1.2913813783397927e-35, 0.0, 0.0, 0.0, 0.0, 0.0, 0.04884313973842984, 0.0, 0.0, -0.053234509749396114, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 5.165525513359171e-35, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.05315600134164859, 0.0]

expected["sol_ring"] = {}
expected["sol_ring"]["Pe"] = [1682.2235470913586, 1681.6532479048094, 1681.9383733264822, 1682.223547091359, 1682.2742098498595, 1682.2851030407148, 1682.2854648605025, 1682.2854656934928, 1682.2854656928698, 1682.2854656937216, 1682.2854656938732, 1682.2854656938762, 1682.2854656938762, 1682.2854656938732, 1682.2854656937216, 1682.2854656928698, 1682.2854656934826, 1682.2854648518185, 1682.2851023010198, 1682.274256922003, 1682.2239294382716, 1681.9400478253015, 1681.656214118421, 1682.2239294382712, 1682.1110643569389, 1681.1321681958134, 1681.6215450476805, 1682.1110643569389, 1682.1752328305706, 1682.2196036156886, 1682.2506226296393, 1682.2708089177715, 1682.281458441837, 1682.2849786515706, 1682.285455673886, 1682.2854656773693, 1682.2854656943325, 1682.2854656931559, 1682.2854656937734, 1682.285465693894, 1682.2854656939103, 1682.2854656939103, 1682.285465693894, 1682.2854656937734, 1682.2854656931559, 1682.285465694335, 1682.2854656775025, 1682.2854558612637, 1682.2849914498822, 1682.2815731465419, 1682.271192089276, 1682.2514037136102, 1682.220845847842, 1682.1768922607125, 1682.1128630381158, 1681.6296613338873, 1681.1465984335948, 1682.1128630381156]
expected["sol_ring"]["NVd+"] = [0.0, -0.056123196800296406, -5.109517527362631e-06, -3.6154712135961444e-10, -2.661425102278293e-11, -1.7564229872030303e-12, -1.4981874165092892e-14, -2.451640782616168e-17, 2.2582088811934407e-19, -5.752781442935291e-19, -1.1826870303420756e-19, -7.399899370433813e-21, 7.399900829268362e-21, 1.1826876832885502e-19, 5.752868191806979e-19, -2.2542963067666455e-19, 2.4773965997008987e-17, 1.507293688461222e-14, 1.7545906189149198e-12, 2.6511573295968064e-11, 3.6130824862188135e-10, 5.076592651706649e-06, 0.056123246566621675, 0.0, 0.0, -0.056102553993518066, -1.3141283989206976e-05, -2.239835778930436e-09, -2.2796948052319486e-10, -1.3014034720516664e-10, -6.724485406068325e-11, -2.828771461544768e-11, -8.230316985979058e-12, -1.2860181518060248e-12, -5.904638805814605e-14, -3.441640857040365e-16, -3.5919678855336773e-19, 2.995894423893269e-19, -5.904229023036841e-19, -1.5526161819121974e-19, -2.58826022056111e-20, 2.5882611419547912e-20, 1.5526174484115965e-19, 5.904268248281528e-19, -3.008159779003538e-19, 3.5556867749980033e-19, 3.395796168998508e-16, 5.772729539574173e-14, 1.251318991467548e-12, 8.0016469915638e-12, 2.7556008924309713e-11, 6.572596954617403e-11, 1.2760790220641367e-10, 2.2416638108973448e-10, 2.1751194822538707e-09, 1.2909209037930008e-05, 0.05610315341522171, 0.0]
# Generate test data or run test
if gen_data: 

    # Generate test data, print to console and fail test
    for region_name, ds in regions.items():
        print(f'expected["{region_name}"] = {{}}')
        print(f'expected["{region_name}"]["Pe"] = {ds["Pe"].values.tolist()}')
        print(f'expected["{region_name}"]["NVd+"] = {ds["NVd+"].values.tolist()}')
        print("")

    success = False
else:

    # Perform test
    failures = []
    for region_name, ds in regions.items():

        for variable in ["Pe", "NVd+"]:

            actual = ds[variable]
            reference = expected[region_name][variable]

            try:
                np.testing.assert_allclose(actual, reference, rtol=rtol, atol=atol)
            except AssertionError as e:
                failures.append({
                    "region": region_name,
                    "variable": variable,
                    "error_msg": str(e)
                })
    
    if len(failures) > 0:
        print("2D-production test failures:")
        success = False
        for f in failures:
            print(f"\n{f['region']} [{f['variable']}]:")
            print(f["error_msg"])
        
        exit(1)

    else:
        success = True
        if verbose:
            print("2D-production test: Passed")
        exit(0)

