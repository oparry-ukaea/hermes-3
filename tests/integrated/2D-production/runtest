#!/usr/bin/env python3
from boututils.run_wrapper import shell, launch_safe, getmpirun
import numpy as np
import shutil
import zipfile
import hashlib
from pathlib import Path
import urllib.request
import xhermes

gen_data = False
verbose = False
rtol = 1e-6
atol = 1e-8

## Setup
this_dir = Path(__file__).parent
data_dir = this_dir / "data"
hermes_exec = this_dir.parent.parent.parent / "hermes-3"
output_path = data_dir / "BOUT.dmp.*.nc"

zipfile_path = this_dir / "test-2D-production.zip"
url = "https://zenodo.org/records/18301171/files/test-2D-production-v1.zip"
expected_hash = "b8e2be76791fad1fe7fe8c8734b3020eb63e7da5d69a4fafdf7c9a4695785ff3"
expected_filenames = [
    "BOUT.restart.0.nc",
    "BOUT.restart.1.nc",
    "BOUT.restart.2.nc",
    "BOUT.restart.3.nc",
    "BOUT.restart.4.nc",
    "BOUT.restart.5.nc",
    "BOUT.restart.6.nc",
    "BOUT.restart.7.nc",
    "BOUT.restart.8.nc",
    "BOUT.restart.9.nc",
    "grid_test2.nc",
]


## Download files
tmp_path = zipfile_path.with_name(zipfile_path.name + ".tmp")

with urllib.request.urlopen(url, timeout=60) as response:
    if response.status != 200:
        raise RuntimeError(
            f"2D-Production test: download failed - HTTP {response.status}"
        )

    # Copy bits of the file from response to a temp file
    # This ensures no partial files are left if the download fails
    with open(tmp_path, "wb") as out_file:
        shutil.copyfileobj(response, out_file)

# Rename temp file with the correct name
tmp_path.replace(zipfile_path)

with zipfile.ZipFile(zipfile_path, "r") as zf:
    zip_contents = set(zf.namelist())
    try:
        # Extract only expected grids
        for filename in expected_filenames:
            if filename in zip_contents:
                zf.extract(filename, path=this_dir)

    except Exception as e:
        print("2D-Production test: extracting test grids failed:", e)

# Check hash
with open(zipfile_path, "rb") as f:
    file_hash = hashlib.sha256(f.read()).hexdigest()

if file_hash != expected_hash:
    raise RuntimeError(
        "2D-Production test: downloaded zip file hash does not match expected value"
    )

if verbose:
    print("2D-Production test: downloaded and extracted files")

## Run test
if not Path("hermes-3").is_file():
    shell("ln -s ../../../hermes-3 hermes-3")

runcmd = getmpirun().split(" ")[0] + " --oversubscribe -np"

s, out = launch_safe("./hermes-3 -d data", runcmd=runcmd, nproc=10, pipe=True)

if s != 0:
    print(" => 2D-Production test failed: ")
    print(out)
    exit(1)

if verbose:
    print("2D-Production test: completed simulation")

# Load case
ds = xhermes.open_hermesdataset(
    datapath=output_path,
    gridfilepath=this_dir / "grid_test2.nc",
    keep_yboundaries=True,
    keep_xboundaries=True,
    geometry="toroidal",
).isel(t=-1)

ds = ds.hermes.extract_2d_tokamak_geometry()

if verbose:
    print("2D-Production test: loaded results")


# Testing at specific locations around the domain
m = ds.metadata
x_selection = slice(None)
regions = {}
regions["inner_lower_target"] = ds.isel(x=x_selection, theta=2)
regions["inner_upper_target"] = ds.isel(
    x=x_selection, theta=m["ny_innerg"] - m["MYG"] * 2 - 1
)
regions["outer_upper_target"] = ds.isel(x=x_selection, theta=m["ny_innerg"])
regions["outer_lower_target"] = ds.isel(x=x_selection, theta=-3)
regions["outer_midplane_a"] = ds.isel(
    x=x_selection, theta=int((m["jyseps2_2g"] - m["jyseps1_2g"]) / 2) + m["jyseps1_2g"]
)
regions["sol_boundary"] = ds.isel(x=-3, theta=slice(None))
regions["core_and_pfr_boundary"] = ds.isel(x=0, theta=slice(None))
regions["sol_ring"] = ds.isel(x=m["ixseps1"], theta=slice(None))

# Expected results
# The below line disables Ruff formatting for the data to keep it readable
# fmt: off

expected = {}
expected["inner_lower_target"] = {}
expected["inner_lower_target"]["ddt(Pe)"] = [-2265027870.927243, -3088594452.327487, -8892383001.052448, -8876526635.667227, -8798415941.319464, -8735022113.989939, -8691118533.284332, -8668748074.860023, -8675370485.623285, -8723563817.4824, -8812794753.777378, -8958035879.242682, -9207009697.170935, -9636920320.671741, -10381709563.337618, -11664872273.09693, -13680523999.527414, -16197197376.27697, -3180236839.822052, -2883994136.7039948]
expected["inner_lower_target"]["ddt(NVd+)"] = [22219.858851678473, 9597.699263450266, -98779.40533318976, -98742.95903403373, -97874.0514640709, -97168.85511421802, -96680.46931773829, -96431.61913347087, -96505.28718774185, -97041.39240731698, -98034.00214892022, -99649.67225157129, -102419.27041220572, -107201.61934318159, -115486.69499249222, -129760.66608447107, -152182.88444598104, -180162.75003458382, -21872.340238311986, -17332.060484309914]

expected["inner_upper_target"] = {}
expected["inner_upper_target"]["ddt(Pe)"] = [-2260015354.1849303, -3081073261.299822, -8866517904.92963, -8834868309.580067, -8745192563.459455, -8674094699.779514, -8625940057.27725, -8602123270.304497, -8609867686.883268, -8661451539.989012, -8755945757.836351, -8908705633.407032, -9168419078.062696, -9614404288.621897, -10386057786.127827, -11705147441.583483, -13767492921.1443, -16339740409.803612, -3207859419.7155247, -2908915742.780623]
expected["inner_upper_target"]["ddt(NVd+)"] = [22219.458027285928, 9635.746923855102, 98493.1981795209, 98279.54957129227, 97281.9917427229, 96491.0952777144, 95955.42044093617, 95690.48122004372, 95776.63052744564, 96350.45208794936, 97401.61085695443, 99100.91994063788, 101989.98628731367, 106951.14979039699, 115535.06485728892, 130208.6892280484, 153150.3314140888, 181748.47604665408, -22348.794151500828, -17767.118688481678]

expected["outer_upper_target"] = {}
expected["outer_upper_target"]["ddt(Pe)"] = [-10498153159.008934, -10344211577.626095, -24358399403.98474, -24061716822.78949, -23821530095.267563, -23602060953.637554, -23399928402.661015, -23212819740.2457, -23039277204.42444, -22877547845.148453, -22716090026.085594, -22519251314.825783, -22240578713.35649, -21865331391.265083, -21451074832.54568, -21169692517.620068, -21311583342.547962, -22038201366.648922, -4450898718.276243, -4770854685.261297]
expected["outer_upper_target"]["ddt(NVd+)"] = [-98542.02075061985, -96182.6787722521, -270596.80877701007, -267663.8325179284, -264991.98242536205, -262550.59587401984, -260302.06249075758, -258220.65565294676, -256290.15913796547, -254491.07303507384, -252695.00756014604, -250505.36313497473, -247405.3941079219, -243231.12268768522, -238622.91041849199, -235492.79839363205, -237071.19957260104, -245135.96441831245, -40257.578366908005, -45161.2927328125]

expected["outer_lower_target"] = {}
expected["outer_lower_target"]["ddt(Pe)"] = [-10297275243.260345, -10147297799.73679, -23931512683.55271, -23642664699.051105, -23408456809.03016, -23193540903.208786, -22995457350.485466, -22812721681.167507, -22642406577.388126, -22478151438.04647, -22313501315.569633, -22116504340.9475, -21842831940.603806, -21482749324.1633, -21101608460.476044, -20888214401.18773, -21143298251.89637, -22007115830.290154, -4430845675.993308, -4774175224.498392]
expected["outer_lower_target"]["ddt(NVd+)"] = [-95554.91717038245, -93256.33042640575, 265857.9528164872, 263002.27412520733, 260396.9329430091, 258006.19683198814, 255802.7047233118, 253769.9432961837, 251875.34890902683, 250048.1658926982, 248216.5890627389, 246025.18410748214, 242980.83758715418, 238975.25916935533, 234735.4276752513, 232361.62066777516, 235199.18716169873, 244790.4877429042, -40204.43888527179, -45466.3818179458]

expected["outer_midplane_a"] = {}
expected["outer_midplane_a"]["ddt(Pe)"] = [0.0, 0.0, 2597007.0976860626, -116.86087108067943, -116.79613614165868, -116.76679718104391, -116.74953661195843, -116.74013868711981, -116.73569876705211, -116.733341094614, -116.73165294536234, -116.72969335186067, -116.7267486441265, -116.72204635354036, -116.71399307518048, -116.69788053131573, -116.68675087394335, -3921049.54707126, 2991502.474428581, 0.0]
expected["outer_midplane_a"]["ddt(NVd+)"] = [9878.869556491738, 9878.869556491738, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 42303.353594183274, 42257.50518011016]

expected["sol_boundary"] = {}
expected["sol_boundary"]["ddt(Pe)"] = [0.0, 11638968336.5619, -16197197376.27697, -1374560.1387569993, -1211265.4966704596, -1076129.9707774443, -1160272.7938599123, -1169356.4767372303, -1605960.1664923653, -2418090.456196305, -2828866.056060144, -2917257.746956864, -2917257.7469465104, -2828866.0560756885, -2418090.456197186, -1605960.166504191, -1169356.4544515219, -1159501.4340450694, -1074741.505998484, -1208328.7848486814, -1369577.044105817, -16339740409.803612, 10833048738.086788, 0.0, 0.0, 15012625608.005316, -22038201366.648922, -1557546.7442633123, -1486092.4005945346, -1417192.681873728, -1353788.3662534896, -1293336.694570802, -1195778.1876924394, -1044753.2053826957, -984812.4022292966, -1051881.1184477648, -1047056.3269836863, -1436303.302300092, -2592336.212448632, -3526546.045787264, -3921049.54707126, -3921049.5470649325, -3526546.0458025704, -2592336.212440851, -1436303.3022734984, -1047056.2788308732, -1051035.3386307932, -982793.0982173132, -1040700.1122541969, -1187735.8069691772, -1280961.2355215254, -1337585.0707582578, -1397275.1341639298, -1462657.674274887, -1531191.4776361969, -22007115830.290154, 13446775199.560345, 0.0]
expected["sol_boundary"]["ddt(NVd+)"] = [65859.13037661157, 239754.4605114995, -180162.75003458382, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 181748.47604665408, -147011.4893298713, 65859.13037661157, 65859.13037661157, 304723.5948494299, -245135.96441831245, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 244790.4877429042, -209707.09308219934, 65859.13037661157]

expected["core_and_pfr_boundary"] = {}
expected["core_and_pfr_boundary"]["ddt(Pe)"] = [0.0, 1484734621.1509464, -2265027870.927243, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -2260015354.1849303, 1481242309.2679753, 0.0, 0.0, 1699890337.175253, -10498153159.008934, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -10297275243.260345, 1695668709.176052, 0.0]
expected["core_and_pfr_boundary"]["ddt(NVd+)"] = [56040.12225355923, 38117.27160037717, 22219.858851678473, 56040.12225355923, 54337.552137595456, 51080.56841569074, 48098.71054106545, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 48094.20612716073, 51034.2203132814, 54261.01304994223, 55962.864262106734, 22219.458027285928, 38040.04786003703, 55962.864262106734, 62107.13787505009, 43538.05123050902, -98542.02075061985, 62107.13787505009, 61859.0636208575, 61575.03243681154, 61191.40764657192, 60610.546226303595, 59525.386315913216, 57089.773332481775, 52184.84708259982, 47658.171318169065, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 9878.869556491738, 47654.26685252842, 52105.849539700605, 56960.83537263737, 59398.37849040115, 60499.00890682871, 61089.97666263892, 61480.97954352446, 61772.351904535666, 62017.48632792091, -95554.91717038245, 43446.456418178816, 62017.48632792091]

expected["sol_ring"] = {}
expected["sol_ring"]["ddt(Pe)"] = [0.0, 7557064120.797383, -8812794753.777378, -121.15548451672876, -130.72588963250516, -142.07939099643355, -112.78489291266948, -106.29335275757182, -135.78938979231813, -120.71238544054593, -117.54751733221106, -117.31945103559818, -117.31945103636627, -117.54751733237264, -120.71238543923907, -135.78938979861448, -106.26778497973012, -112.8424846085305, -141.9915649099445, -130.67635254479262, -121.12671519091367, -8755945757.836351, 7211974641.248953, 0.0, 0.0, 15835924265.161343, -22716090026.085594, -116.87879915253876, -117.0556896610491, -117.3435979171412, -117.82975514421585, -118.56915334922968, -119.93821361096734, -126.70527960196176, -131.59612357148396, -111.23556194249736, -108.28372809584738, -130.41319894314782, -119.6803458126236, -117.20854923476958, -116.73165294536234, -116.73165294569029, -117.2085492336248, -119.6803458135414, -130.41319894290393, -108.23819739035541, -111.30076767894147, -131.59708309420512, -126.68228168724983, -119.9012279880583, -118.54055987296725, -117.82229870209582, -117.34287274983217, -117.05440623712336, -116.87675343373613, -22313501315.569633, 13893636012.962894, 0.0]
expected["sol_ring"]["ddt(NVd+)"] = [65859.13037661157, 160204.39946792455, -98034.00214892022, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 97401.61085695443, -65179.58740590395, 65859.13037661157, 65859.13037661157, 320480.1440819764, -252695.00756014604, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 248216.5890627389, -220769.96378167893, 65859.13037661157]# fmt: on

# fmt: on

# Generate test data or run test
if gen_data:
    # Generate test data, print to console and fail test
    for region_name, ds in regions.items():
        print(f'expected["{region_name}"] = {{}}')
        print(f'expected["{region_name}"]["ddt(Pe)"] = {ds["ddt(Pe)"].values.tolist()}')
        print(f'expected["{region_name}"]["ddt(NVd+)"] = {ds["ddt(NVd+)"].values.tolist()}')
        print("")

else:
    # Perform test
    failures = []
    for region_name, ds in regions.items():
        for variable in ["ddt(Pe)", "ddt(NVd+)"]:
            actual = ds[variable]
            reference = expected[region_name][variable]

            try:
                np.testing.assert_allclose(actual, reference, rtol=rtol, atol=atol)
            except AssertionError as e:
                failures.append(
                    {"region": region_name, "variable": variable, "error_msg": str(e)}
                )

    if len(failures) > 0:
        print("2D-production test failures:")
        for f in failures:
            print(f"\n{f['region']} [{f['variable']}]:")
            print(f["error_msg"])

        exit(1)

    else:
        if verbose:
            print("2D-production test: Passed")
        exit(0)
